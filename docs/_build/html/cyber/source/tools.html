<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cyber组件启动 &mdash; dig-into-apollo  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> dig-into-apollo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../what_is_apollo/readme.html">Dig into Apollo - Introduction </a></li>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Dig into Apollo - Cyber </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/readme.html">Dig into Apollo - Docker </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library/readme.html">Dig into Apollo - Library </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../papers/readme.html">Dig into Apollo - Papers </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/readme.html">Dig into Apollo - Performance </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../questions/readme.html">Dig into Apollo - Questions </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulation/readme.html">Dig into Apollo - Simulation </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_build/readme.html">Dig into Apollo - Build </a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dig-into-apollo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>cyber组件启动</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/cyber/source/tools.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="cyber">
<h1>cyber组件启动<a class="headerlink" href="#cyber" title="Permalink to this headline"></a></h1>
<p>cyber_launch主要用来启动cyber模块，其中一个launch文件可以有一个或者多个module，每个module 包含一个dag文件，而一个dag文件则对应一个或者多个components。<br />
launch文件中有几个module则会启动几个<em>进程</em>，每个进程有单独的内存空间，比如静态变量等都不会共享。<br />
一个dag文件中可以有一个或者多个components，一个components对应一个协程。协程中的静态变量是共享的，并且全局唯一。</p>
<p>理解了上述原理，我们再详细分析以下2种启动方式。</p>
<ol class="arabic simple">
<li><p>cyber_launch</p></li>
<li><p>dreamview
实际上上述2种启动方式没有太大区别，都是通过<code class="docutils literal notranslate"><span class="pre">mainboard</span></code>来启动程序，而一个dag文件对应一个进程，接着根据dag文件中有几个components，生成几个协程，每个components对应一个协程。</p></li>
</ol>
<p>下面介绍下cyber_launch的文件结构。</p>
</div>
<div class="section" id="cyber-launch">
<h1>cyber_launch<a class="headerlink" href="#cyber-launch" title="Permalink to this headline"></a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">cyber</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">planning</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>   \\ <span class="n">module名称</span>
        <span class="o">&lt;</span><span class="n">dag_conf</span><span class="o">&gt;/</span><span class="n">apollo</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">planning</span><span class="o">/</span><span class="n">dag</span><span class="o">/</span><span class="n">planning</span><span class="o">.</span><span class="n">dag</span><span class="o">&lt;/</span><span class="n">dag_conf</span><span class="o">&gt;</span>   \\ <span class="n">module的dag文件</span>
        <span class="o">&lt;</span><span class="n">process_name</span><span class="o">&gt;</span><span class="n">planning</span><span class="o">&lt;/</span><span class="n">process_name</span><span class="o">&gt;</span>   \\ <span class="n">指定调度文件</span>
    <span class="o">&lt;/</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">cyber</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>module 用于区分模块</p></li>
<li><p>name  模块名称，主要用来cyber_launch启动的时候显示名称</p></li>
<li><p>dag_conf  module模块对应的dag文件</p></li>
<li><p>process_name  指定module的调度文件，如果找不到则会提示</p></li>
</ul>
</div>
<div class="section" id="dag">
<h1>dag<a class="headerlink" href="#dag" title="Permalink to this headline"></a></h1>
<p>下面以<code class="docutils literal notranslate"><span class="pre">velodyne.dag</span></code>文件为例来进行说明。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>module_config {
    module_library : &quot;/apollo/bazel-bin/modules/drivers/lidar/velodyne/driver/libvelodyne_driver_component.so&quot;
    // 模块的so文件，用于加载到内存
    # 128
    components {  // 第1个组件
      class_name : &quot;VelodyneDriverComponent&quot;
      config {
        name : &quot;velodyne_128_driver&quot;   // 名称必须不一样
        // 配置文件
        config_file_path : &quot;/apollo/modules/drivers/lidar/velodyne/conf/velodyne128_conf.pb.txt&quot;
      }
    }
    # 16_front_up
    components {  // 第2个组件
      class_name : &quot;VelodyneDriverComponent&quot;
      config {
        name : &quot;velodyne_16_front_up_driver&quot;
        config_file_path : &quot;/apollo/modules/drivers/lidar/velodyne/conf/velodyne16_front_up_conf.pb.txt&quot;
      }
    }
}

module_config {
    module_library : &quot;/apollo/bazel-bin/modules/drivers/lidar/velodyne/parser/libvelodyne_convert_component.so&quot;
    // 模块的so文件，用于加载到内存
    # 128
    components {
      class_name : &quot;VelodyneConvertComponent&quot;
      config {
        name : &quot;velodyne_128_convert&quot;   
        config_file_path : &quot;/apollo/modules/drivers/lidar/velodyne/conf/velodyne128_conf.pb.txt&quot;
        readers {
          channel: &quot;/apollo/sensor/lidar128/Scan&quot;
        }
      }
    }
    # 16_front_up_center
    components {
      class_name : &quot;VelodyneConvertComponent&quot;
      config {
        name : &quot;velodyne_16_front_up_convert&quot;
        config_file_path : &quot;/apollo/modules/drivers/lidar/velodyne/conf/velodyne16_front_up_conf.pb.txt&quot;
        readers {
          channel: &quot;/apollo/sensor/lidar16/front/up/Scan&quot;
        }
      }
    }
}
</pre></div>
</div>
<p>dag文件有一个或者多个module_config，而每个module_config中对应一个或者多个components。</p>
</div>
<div class="section" id="cyber-launch-py">
<h1>cyber_launch.py分析<a class="headerlink" href="#cyber-launch-py" title="Permalink to this headline"></a></h1>
<div class="section" id="start">
<h2>start<a class="headerlink" href="#start" title="Permalink to this headline"></a></h2>
<p>在start函数中会遍历module，然后通过</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">process_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">process_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">process_type</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Start binary failed. Binary process_name is null.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="n">ProcessWrapper</span><span class="p">(</span>
                <span class="n">process_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
                    <span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">process_name</span><span class="p">,</span> <span class="n">process_type</span><span class="p">,</span>
                <span class="n">exception_handler</span><span class="p">)</span>
        <span class="c1"># Default is library</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="n">ProcessWrapper</span><span class="p">(</span>
                <span class="n">g_binary_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dag_dict</span><span class="p">[</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">process_name</span><span class="p">)],</span> <span class="n">process_name</span><span class="p">,</span>
                <span class="n">process_type</span><span class="p">,</span> <span class="n">sched_name</span><span class="p">,</span> <span class="n">exception_handler</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Start manager [</span><span class="si">%s</span><span class="s1">] failed. Stop all!&#39;</span> <span class="o">%</span> <span class="n">process_name</span><span class="p">)</span>
            <span class="n">stop</span><span class="p">()</span>
        <span class="n">pmon</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span>
        <span class="n">process_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span>	
</pre></div>
</div>
<p>而ProcessWrapper中通过<code class="docutils literal notranslate"><span class="pre">subprocess.Popen</span></code>启动新的进程。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>	<span class="bp">self</span><span class="o">.</span><span class="n">popen</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args_list</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
	                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="stop">
<h2>stop<a class="headerlink" href="#stop" title="Permalink to this headline"></a></h2>
<p>stop实际上是通过找到对应的launch文件，并且杀掉对应的进程来实现。(kill对应的是PID，pkill对应的是command)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stop_launch</span><span class="p">(</span><span class="n">launch_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stop the launch file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">launch_file</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;pkill -INT cyber_launch&#39;</span>   <span class="c1"># 杀掉对应的进程</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;pkill -INT -f &#39;</span> <span class="o">+</span> <span class="n">launch_file</span>  <span class="c1"># 杀掉对应的进程</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stop cyber launch finished.&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="mainboard">
<h1>mainboard<a class="headerlink" href="#mainboard" title="Permalink to this headline"></a></h1>
<p>mainboard通过LoadModule来加载模块，而<code class="docutils literal notranslate"><span class="pre">module_config</span></code>来指定加载的so文件，然后启动一个或者多个components，每个components的配置文件可以不一样。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ModuleController::LoadModule</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DagConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">dag_config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">work_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">WorkRoot</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">module_config</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dag_config</span><span class="p">.</span><span class="n">module_config</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">load_path</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">module_config</span><span class="p">.</span><span class="n">module_library</span><span class="p">().</span><span class="n">front</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">load_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module_config</span><span class="p">.</span><span class="n">module_library</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">load_path</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">common</span><span class="o">::</span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span><span class="w"> </span><span class="n">module_config</span><span class="p">.</span><span class="n">module_library</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">::</span><span class="n">PathExists</span><span class="p">(</span><span class="n">load_path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Path does not exist: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">load_path</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 1. 加载模块的so文件</span>
<span class="w">    </span><span class="n">class_loader_manager_</span><span class="p">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">load_path</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2.1 加载触发模块</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">module_config</span><span class="p">.</span><span class="n">components</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">class_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="n">class_name</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ComponentBase</span><span class="o">&gt;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">class_loader_manager_</span><span class="p">.</span><span class="n">CreateClassObj</span><span class="o">&lt;</span><span class="n">ComponentBase</span><span class="o">&gt;</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="n">component</span><span class="p">.</span><span class="n">config</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">component_list_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">base</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 2.2 加载定时模块</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">module_config</span><span class="p">.</span><span class="n">timer_components</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">class_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="n">class_name</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ComponentBase</span><span class="o">&gt;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">class_loader_manager_</span><span class="p">.</span><span class="n">CreateClassObj</span><span class="o">&lt;</span><span class="n">ComponentBase</span><span class="o">&gt;</span><span class="p">(</span><span class="n">class_name</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="n">component</span><span class="p">.</span><span class="n">config</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">component_list_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">base</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="dreamview">
<h1>dreamview<a class="headerlink" href="#dreamview" title="Permalink to this headline"></a></h1>
<p>dreamview通过界面上的滑动按钮打开和关闭模块，大概的流程是前端通过websocket发送消息到后端，后端通过调用命令行启动模块，后端主要的实现在”hmi_worker.cc”中。</p>
<p>dreamview中的modules通过指定”start_command”和”stop_command”来启动和关闭。</p>
<div class="section" id="loadmode">
<h2>LoadMode<a class="headerlink" href="#loadmode" title="Permalink to this headline"></a></h2>
<p>对于so文件，会通过LoadMode来进行生成命令，下面介绍下生成”start_command”和”stop_command”的过程。生成的命令和cyber_launch中调用的命令一致，只是前面增加了<code class="docutils literal notranslate"><span class="pre">nohup</span></code>。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">HMIMode</span><span class="w"> </span><span class="nf">HMIWorker::LoadMode</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mode_config_path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">HMIMode</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">mode_config_path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mode</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Unable to parse HMIMode from file &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mode_config_path</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Translate cyber_modules to regular modules.</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span><span class="n">cyber_modules</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">module_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CyberModule</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cyber_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Each cyber module should have at least one dag file.</span>
<span class="w">    </span><span class="n">ACHECK</span><span class="p">(</span><span class="o">!</span><span class="n">cyber_module</span><span class="p">.</span><span class="n">dag_files</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;None dag file is provided for &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">module_name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; module in &quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mode_config_path</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">Module</span><span class="o">&amp;</span><span class="w"> </span><span class="k">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LookupOrInsert</span><span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">mutable_modules</span><span class="p">(),</span><span class="w"> </span><span class="n">module_name</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>
<span class="w">    </span><span class="k">module</span><span class="p">.</span><span class="n">set_required_for_safety</span><span class="p">(</span><span class="n">cyber_module</span><span class="p">.</span><span class="n">required_for_safety</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 1. Construct start_command:</span>
<span class="w">    </span><span class="c1">//     nohup mainboard -p &lt;process_group&gt; -d &lt;dag&gt; ... &amp;</span>
<span class="w">    </span><span class="k">module</span><span class="p">.</span><span class="n">set_start_command</span><span class="p">(</span><span class="s">&quot;nohup mainboard&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">process_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cyber_module</span><span class="p">.</span><span class="n">process_group</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">process_group</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">absl</span><span class="o">::</span><span class="n">StrAppend</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="n">mutable_start_command</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; -p &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">process_group</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">dag</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cyber_module</span><span class="p">.</span><span class="n">dag_files</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">absl</span><span class="o">::</span><span class="n">StrAppend</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="n">mutable_start_command</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; -d &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dag</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">absl</span><span class="o">::</span><span class="n">StrAppend</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="n">mutable_start_command</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; &amp;&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 2. Construct stop_command: pkill -f &#39;&lt;dag[0]&gt;&#39;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">first_dag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cyber_module</span><span class="p">.</span><span class="n">dag_files</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">module</span><span class="p">.</span><span class="n">set_stop_command</span><span class="p">(</span><span class="n">absl</span><span class="o">::</span><span class="n">StrCat</span><span class="p">(</span><span class="s">&quot;pkill -f </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">first_dag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Construct process_monitor_config.</span>
<span class="w">    </span><span class="k">module</span><span class="p">.</span><span class="n">mutable_process_monitor_config</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_command_keywords</span><span class="p">(</span><span class="s">&quot;mainboard&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">module</span><span class="p">.</span><span class="n">mutable_process_monitor_config</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_command_keywords</span><span class="p">(</span><span class="n">first_dag</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">mode</span><span class="p">.</span><span class="n">clear_cyber_modules</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>接着调用<code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">HMIWorker::StartModule(const</span> <span class="pre">std::string&amp;</span> <span class="pre">module)</span> <span class="pre">const</span></code>来启动模块，启动调用的<code class="docutils literal notranslate"><span class="pre">std::system()</span></code>来启动命令行，也是一个dag文件对应一个进程。dag中的模块都对应协程。</p>
</div>
</div>
<div class="section" id="id1">
<h1>用途<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p>如何启动2个一模一样的模块</p>
<ol class="arabic simple">
<li><p>如果你需要启动2个相同的模块，可以在launch文件中增加2个module，并且修改dag文件中模块的名称，这样就可以启动2个一模一样的模块了。上述这种情况在模块中有静态变量，并且你希望静态变量不相互影响的情况下可以采用。</p></li>
<li><p>如果需要在同一个进程中启动2个模块，可以在dag中增加components，然后修改config中的名称和配置文件，这样就可以启动2个一模一样的模块了。上述这种情况静态变量会相互影响，A模块改了，B模块的静态变量值也改变了。</p></li>
</ol>
<p>perception中的inner消息订阅不到？
perception模块中的inner消息只有在同一个进程中才会收到，也就是在同一个dag文件中启动的模块才会接收到，因为reader读取的时候会判断2个节点是否是在同一个进程，如果是同一个进程就直接传递对象，不进行序列化，如果不是同一个进程则先进行序列化，然后再通过共享内存通信。</p>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, daohu527.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>