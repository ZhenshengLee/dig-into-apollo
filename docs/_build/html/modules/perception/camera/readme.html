<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>camera &mdash; dig-into-apollo  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> dig-into-apollo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../what_is_apollo/readme.html">Dig into Apollo - Introduction </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cyber/readme.html">Dig into Apollo - Cyber </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/readme.html">Dig into Apollo - Docker </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library/readme.html">Dig into Apollo - Library </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../papers/readme.html">Dig into Apollo - Papers </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance/readme.html">Dig into Apollo - Performance </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../questions/readme.html">Dig into Apollo - Questions </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simulation/readme.html">Dig into Apollo - Simulation </a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to_build/readme.html">Dig into Apollo - Build </a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dig-into-apollo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>camera</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/modules/perception/camera/readme.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <a name="camera_module" />
<div class="section" id="camera">
<h1>camera<a class="headerlink" href="#camera" title="Permalink to this headline"></a></h1>
<p>camera模块的结构和radar类似，目录如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── app        \\ 主程序
├── common     \\ 公共程序
├── lib         \\ 库，用来做红绿灯、障碍物检测等功能
├── test        \\ 测试用例
└── tools       \\ 工具，用来做车道线和红绿灯识别结果展示
</pre></div>
</div>
</div>
<div class="section" id="lib">
<h1>lib目录<a class="headerlink" href="#lib" title="Permalink to this headline"></a></h1>
</div>
<div class="section" id="traffic-light">
<h1>traffic_light<a class="headerlink" href="#traffic-light" title="Permalink to this headline"></a></h1>
<p>红绿灯的识别分为3个阶段，先预处理，然后识别，然后跟踪？
preprocessor // 预处理
detector - detection     // 检测
- recognition   // 识别，通过上面的detection检测？？？
tracker // 追踪红绿灯</p>
<div class="section" id="preprocessor">
<h2>preprocessor预处理<a class="headerlink" href="#preprocessor" title="Permalink to this headline"></a></h2>
<p>首先来看红绿灯预处理，主要有个文件”pose.cc”,”multi_camera_projection.cc”和”tl_preprocessor.cc”，先看”pose.cc”的实现。</p>
<p>在”pose.cc”中实现了”CarPose”类，主要作用是获取车的位置和姿态，从而获取到相机的位置和姿态。在”CarPose”中定义了如下数据结构。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix4d</span> <span class="n">pose_</span><span class="p">;</span>  <span class="o">//</span> <span class="n">car</span><span class="p">(</span><span class="n">novatel</span><span class="p">)</span> <span class="n">to</span> <span class="n">world</span> <span class="n">pose</span>
  <span class="n">std</span><span class="p">::</span><span class="nb">map</span><span class="o">&lt;</span><span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="p">,</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix4d</span><span class="o">&gt;</span> <span class="n">c2w_poses_</span><span class="p">;</span>  <span class="o">//</span> <span class="n">camera</span> <span class="n">to</span> <span class="n">world</span> <span class="n">poses</span>
  <span class="n">double</span> <span class="n">timestamp_</span><span class="p">;</span>
</pre></div>
</div>
<p>其中”c2w_poses_”存放了不同焦距的相机到世界坐标的转换矩阵。</p>
<p>获取车的位置和姿态的实现如下，这里是默认车的坐标为0？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 初始化车到世界坐标的转换矩阵</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">CarPose::Init</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4d</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">timestamp_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">pose_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pose</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4d</span><span class="w"> </span><span class="nf">CarPose::getCarPose</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">pose_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="nf">CarPose::getCarPosition</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pose_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pose_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pose_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>获取相机到世界坐标的转换矩阵。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CarPose::SetCameraPose</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_name</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4d</span><span class="w"> </span><span class="o">&amp;</span><span class="n">c2w_pose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c2w_poses_</span><span class="p">[</span><span class="n">camera_name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2w_pose</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">CarPose::GetCameraPose</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_name</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4d</span><span class="w"> </span><span class="o">*</span><span class="n">c2w_pose</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c2w_pose</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;c2w_pose is not available&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c2w_poses_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">camera_name</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">c2w_poses_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">c2w_pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2w_poses_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">camera_name</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>删除某个相机到世界坐标的转换矩阵。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CarPose::ClearCameraPose</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2w_poses_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">camera_name</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">c2w_poses_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">c2w_poses_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>这里还提供了重载的输入输出流”&lt;&lt;”，有个疑问这里的”pose_”类型为”Eigen::Matrix4d”打印的时候会直接展开吗？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">CarPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pose</span><span class="p">.</span><span class="n">pose_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">os</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>“multi_camera_projection.cc”中实现了”MultiCamerasProjection”类，先看数据结构。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// sorted by focal length in descending order</span>
<span class="w">  </span><span class="c1">// 1. 相机名称，按照焦距升序排列</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">camera_names_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// camera_name -&gt; camera_model</span>
<span class="w">  </span><span class="c1">// 2. 根据相机名称，获取对应的相机模型</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">BrownCameraDistortionModelPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">camera_models_</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>首先看”MultiCamerasProjection”类的初始化流程。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">MultiCamerasProjection::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MultiCamerasInitOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 初始化sensor_manager</span>
<span class="w">  </span><span class="n">common</span><span class="o">::</span><span class="n">SensorManager</span><span class="o">*</span><span class="w"> </span><span class="n">sensor_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">SensorManager</span><span class="o">::</span><span class="n">Instance</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sensor_manager</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;sensor_manager init failed&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 遍历相机列表</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">camera_names</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cur_camera_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">camera_names</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 3. 查看相机是否存在</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sensor_manager</span><span class="o">-&gt;</span><span class="n">IsSensorExist</span><span class="p">(</span><span class="n">cur_camera_name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;sensor &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cur_camera_name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; do not exist&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 4. 从sensor_manager中获取相机模型</span>
<span class="w">    </span><span class="n">camera_models_</span><span class="p">[</span><span class="n">cur_camera_name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">dynamic_pointer_cast</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">BrownCameraDistortionModel</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">sensor_manager</span><span class="o">-&gt;</span><span class="n">GetDistortCameraModel</span><span class="p">(</span><span class="n">cur_camera_name</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">camera_names_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cur_camera_name</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// sort camera_names_ by focal lengths (descending order)</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">camera_names_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">camera_names_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">lhs_cam_intrinsics</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">camera_models_</span><span class="p">[</span><span class="n">lhs</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_intrinsic_params</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">rhs_cam_intrinsics</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">camera_models_</span><span class="p">[</span><span class="n">rhs</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_intrinsic_params</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="c1">// 5. 计算焦点长度，并且比较大小</span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">lhs_focal_length</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">lhs_cam_intrinsics</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lhs_cam_intrinsics</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rhs_focal_length</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">rhs_cam_intrinsics</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rhs_cam_intrinsics</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">lhs_focal_length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rhs_focal_length</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 6. 打印相机名称数组，用空格隔开</span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;camera_names sorted by descending focal lengths: &quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">camera_names_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">camera_names_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">                           </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                           </span><span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                             </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                           </span><span class="p">});</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>投影</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">MultiCamerasProjection::Project</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CarPose</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pose</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="n">ProjectOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLight</span><span class="o">*</span><span class="w"> </span><span class="n">light</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4d</span><span class="w"> </span><span class="n">c2w_pose</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 通过相机名称获取相机到世界坐标的转换矩阵</span>
<span class="w">  </span><span class="n">c2w_pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pose</span><span class="p">.</span><span class="n">c2w_poses_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">camera_name</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// 2. 根据 红绿灯区域坐标点 获取 相机上红绿灯投影点</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BoundaryBasedProject</span><span class="p">(</span><span class="n">camera_models_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">camera_name</span><span class="p">),</span><span class="w"> </span><span class="n">c2w_pose</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">light</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Projection failed projection the traffic light. &quot;</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;camera_name: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="n">camera_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>再接着看”BoundaryBasedProject”的实现。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">MultiCamerasProjection::BoundaryBasedProject</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">BrownCameraDistortionModelPtr</span><span class="w"> </span><span class="n">camera_model</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4d</span><span class="o">&amp;</span><span class="w"> </span><span class="n">c2w_pose</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">PointXYZID</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">points</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLight</span><span class="o">*</span><span class="w"> </span><span class="n">light</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 获取照片的宽度和高度</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">camera_model</span><span class="o">-&gt;</span><span class="n">get_width</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">camera_model</span><span class="o">-&gt;</span><span class="n">get_height</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 2. 获取红绿灯框，必须大于等于4个点</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">bound_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">points</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2i</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pts2d</span><span class="p">(</span><span class="n">bound_size</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 3. 相机到世界坐标的逆矩阵</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">c2w_pose_inverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2w_pose</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bound_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pt3d_world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 4. 红绿灯世界坐标到相机坐标</span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">pt3d_cam</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">c2w_pose_inverse</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">         </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="p">(</span><span class="n">pt3d_world</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">pt3d_world</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">pt3d_world</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 5. 如果距离小于0，则表示已经经过了红绿灯（红绿灯在车后面）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">islessequal</span><span class="p">(</span><span class="n">pt3d_cam</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;light bound point behind the car: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pt3d_cam</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 6. 从3D投影到2D</span>
<span class="w">    </span><span class="n">pts2d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_model</span><span class="o">-&gt;</span><span class="n">Project</span><span class="p">(</span><span class="n">pt3d_cam</span><span class="p">.</span><span class="n">cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">()).</span><span class="n">cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 7. 在一系列点中找到左下角和右上角的点，刚好能够包围投影出来的点</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">min_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">max_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">min_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">max_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">pts2d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">min_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">min_x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">max_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">max_x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">min_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">min_y</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">max_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">max_y</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 8. 构造图片中感兴趣的区域位置，也就是红绿灯的位置</span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">BBox2DI</span><span class="w"> </span><span class="n">roi</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span><span class="w"> </span><span class="n">min_y</span><span class="p">,</span><span class="w"> </span><span class="n">max_x</span><span class="p">,</span><span class="w"> </span><span class="n">max_y</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 9. 感兴趣区域为0，或者超过图片的范围，图片的坐标起点为（0，0）</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutOfValidRegion</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">roi</span><span class="p">.</span><span class="n">Area</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Projection get ROI outside the image. &quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">RectI</span><span class="p">(</span><span class="n">roi</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>疑问</strong>：</p>
<ol class="arabic simple">
<li><p>这里的图片的坐标系是如何的？坐标起点为图片左上角，向下为y轴，向右为x轴？？？</p></li>
</ol>
<p>“tl_preprocessor.cc”中实现了”TLPreprocessor”类。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TLPreprocessor::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TrafficLightPreprocessorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">camera</span><span class="o">::</span><span class="n">MultiCamerasInitOption</span><span class="w"> </span><span class="n">projection_init_option</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">projection_init_option</span><span class="p">.</span><span class="n">camera_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">camera_names</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 初始化 MultiCamerasProjection projection_</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">projection_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">projection_init_option</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;init multi_camera_projection failed.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">num_cameras_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">projection_</span><span class="p">.</span><span class="n">getCameraNamesByDescendingFocalLen</span><span class="p">().</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 2. 这里申明2个数组，分别代表红绿灯在图片内，和红绿灯不在图片内</span>
<span class="w">  </span><span class="n">lights_on_image_array_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">num_cameras_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">lights_outside_image_array_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">num_cameras_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 3. 同步间隔</span>
<span class="w">  </span><span class="n">sync_interval_seconds_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">sync_interval_seconds</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>更新选择的相机</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TLPreprocessor::UpdateCameraSelection</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CarPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">TLPreprocessorOption</span><span class="w"> </span><span class="o">&amp;</span><span class="n">option</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pose</span><span class="p">.</span><span class="n">getTimestamp</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 选择当前时间，最大焦距</span>
<span class="w">  </span><span class="n">selected_camera_name_</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">selected_camera_name_</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetMaxFocalLenWorkingCameraName</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. </span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ProjectLightsAndSelectCamera</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="o">&amp;</span><span class="p">(</span><span class="n">selected_camera_name_</span><span class="p">.</span><span class="n">second</span><span class="p">),</span><span class="w"> </span><span class="n">lights</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;project_lights_and_select_camera failed, ts: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>接下来我们接着看”ProjectLightsAndSelectCamera”。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TLPreprocessor::ProjectLightsAndSelectCamera</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CarPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">TLPreprocessorOption</span><span class="w"> </span><span class="o">&amp;</span><span class="n">option</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">*</span><span class="n">selected_camera_name</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 清除数组</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">light_ptrs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lights_on_image_array_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">light_ptrs</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">light_ptrs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lights_outside_image_array_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">light_ptrs</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 根据焦距获取相机名称</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">projection_</span><span class="p">.</span><span class="n">getCameraNamesByDescendingFocalLen</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">cam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">cam_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_cameras_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">cam_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_names</span><span class="p">[</span><span class="n">cam_id</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 3. 获取投影</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ProjectLights</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="n">camera_name</span><span class="p">,</span><span class="w"> </span><span class="n">lights</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="o">&amp;</span><span class="p">(</span><span class="n">lights_on_image_array_</span><span class="p">[</span><span class="n">cam_id</span><span class="p">]),</span><span class="w"></span>
<span class="w">                       </span><span class="o">&amp;</span><span class="p">(</span><span class="n">lights_outside_image_array_</span><span class="p">[</span><span class="n">cam_id</span><span class="p">])))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;select_camera_by_lights_projection project lights on &quot;</span><span class="w"></span>
<span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">camera_name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; image failed&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">projections_outside_all_images_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">lights</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">cam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">cam_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_cameras_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">cam_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">projections_outside_all_images_</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">projections_outside_all_images_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">lights_on_image_array_</span><span class="p">[</span><span class="n">cam_id</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lights</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">projections_outside_all_images_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;lights projections outside all images&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 4. 选择相机</span>
<span class="w">  </span><span class="n">SelectCamera</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lights_on_image_array_</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lights_outside_image_array_</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">selected_camera_name</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>投影红绿灯</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TLPreprocessor::ProjectLights</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CarPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_name</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtrs</span><span class="w"> </span><span class="o">*</span><span class="n">lights_on_image</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtrs</span><span class="w"> </span><span class="o">*</span><span class="n">lights_outside_image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 1. 查看相机是否工作，通过查找&quot;camera_is_working_flags_&quot;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_working</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">GetCameraWorkingFlag</span><span class="p">(</span><span class="n">camera_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">is_working</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">is_working</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;TLPreprocessor::project_lights not project lights, &quot;</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;camera is not working, camera_name: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">camera_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 遍历红绿灯，并且找到红绿灯在相机上的投影</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lights</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="w"> </span><span class="n">light_proj</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLight</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lights</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">projection_</span><span class="p">.</span><span class="n">Project</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="n">ProjectOption</span><span class="p">(</span><span class="n">camera_name</span><span class="p">),</span><span class="w"> </span><span class="n">light</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// 3. 没有红绿灯投影在相机上，放入 lights_outside_image</span>
<span class="w">      </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">outside_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="n">light_proj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">light</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">lights_outside_image</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">light_proj</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// 4. 有红绿灯投影在相机上，放入 lights_on_image</span>
<span class="w">      </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">outside_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="n">light_proj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">light</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">lights_on_image</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">light_proj</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>疑问</strong>：</p>
<ol class="arabic simple">
<li><p>智能指针先指向一个对象，后面重新指向另外一个对象，前面这个对象会自动释放内存？？？</p></li>
</ol>
<p>选择相机，这里如何选择的？？？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">TLPreprocessor::SelectCamera</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtrs</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights_on_image_array</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtrs</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights_outside_image_array</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">TLPreprocessorOption</span><span class="w"> </span><span class="o">&amp;</span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">*</span><span class="n">selected_camera_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 获取焦距最小的相机名称</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">min_focal_len_working_camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetMinFocalLenWorkingCameraName</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">projection_</span><span class="p">.</span><span class="n">getCameraNamesByDescendingFocalLen</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">cam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">cam_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lights_on_image_array</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">cam_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_names</span><span class="p">[</span><span class="n">cam_id</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_working</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 2. 如果相机没有工作，则跳过</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">GetCameraWorkingFlag</span><span class="p">(</span><span class="n">camera_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">is_working</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">is_working</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;camera &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">camera_name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;is not working&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">camera_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">min_focal_len_working_camera</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// 如果投影在外的相机大于0</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lights_outside_image_array</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">cam_id</span><span class="p">).</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">lights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lights_on_image_array</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">cam_id</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 如果红绿灯超出范围</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutOfValidRegion</span><span class="p">(</span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">projection_</span><span class="p">.</span><span class="n">getImageWidth</span><span class="p">(</span><span class="n">camera_name</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">projection_</span><span class="p">.</span><span class="n">getImageHeight</span><span class="p">(</span><span class="n">camera_name</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">option</span><span class="p">.</span><span class="n">image_borders_size</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">camera_name</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// 如果是最小的焦距，红绿灯的个数是否大于0</span>
<span class="w">      </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lights_on_image_array</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">cam_id</span><span class="p">).</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="n">selected_camera_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_name</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;select_camera selection: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">selected_camera_name</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>更新红绿灯投影</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TLPreprocessor::UpdateLightsProjection</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CarPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">TLPreprocessorOption</span><span class="w"> </span><span class="o">&amp;</span><span class="n">option</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_name</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">lights_on_image_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">lights_outside_image_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;clear lights_outside_image_ &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">lights_outside_image_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lights</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;No lights to be projected&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ProjectLights</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span><span class="w"> </span><span class="n">camera_name</span><span class="p">,</span><span class="w"> </span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lights_on_image_</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="o">&amp;</span><span class="n">lights_outside_image_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;update_lights_projection project lights on &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">camera_name</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; image failed&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lights_outside_image_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;update_lights_projection failed,&quot;</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;lights_outside_image-&gt;size() &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">lights_outside_image_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ts: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pose</span><span class="p">.</span><span class="n">getTimestamp</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">min_focal_len_working_camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetMinFocalLenWorkingCameraName</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">camera_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">min_focal_len_working_camera</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lights_on_image_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="w"> </span><span class="o">&amp;</span><span class="n">light</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lights_on_image_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutOfValidRegion</span><span class="p">(</span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">projection_</span><span class="p">.</span><span class="n">getImageWidth</span><span class="p">(</span><span class="n">camera_name</span><span class="p">),</span><span class="w"></span>
<span class="w">                         </span><span class="n">projection_</span><span class="p">.</span><span class="n">getImageHeight</span><span class="p">(</span><span class="n">camera_name</span><span class="p">),</span><span class="w"></span>
<span class="w">                         </span><span class="n">option</span><span class="p">.</span><span class="n">image_borders_size</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">camera_name</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;update_lights_projection light project out of image region. &quot;</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;camera_name: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">camera_name</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;UpdateLightsProjection success&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>更新信息</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TLPreprocessor::SyncInformation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">image_timestamp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cam_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">&amp;</span><span class="n">proj_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selected_camera_name_</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">proj_camera_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selected_camera_name_</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">projection_</span><span class="p">.</span><span class="n">HasCamera</span><span class="p">(</span><span class="n">cam_name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;sync_image failed, &quot;</span><span class="w"></span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;get invalid camera_name: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cam_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">image_timestamp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">last_pub_img_ts_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;TLPreprocessor reject the image pub ts:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">image_timestamp</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; which is earlier than last output ts:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">last_pub_img_ts_</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, image_camera_name: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cam_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proj_camera_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cam_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;sync_image failed - find close enough projection,&quot;</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;but camera_name not match.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">last_pub_img_ts_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_timestamp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="detector">
<h2>detector 检测<a class="headerlink" href="#detector" title="Permalink to this headline"></a></h2>
<p>红绿灯的检测分为2部分，一部分为检测，一部分为识别，分别在”detection”和”recognition”2个目录中。我们先看”detection”的实现。</p>
<p>在”cropbox.h”和”cropbox.cc”中获取裁剪框。首先是初始化裁切尺度”crop_scale”和最小裁切大小”min_crop_size”</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CropBox::Init</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">crop_scale</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">min_crop_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">crop_scale_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crop_scale</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">min_crop_size_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_crop_size</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">CropBox</span><span class="o">::</span><span class="n">CropBox</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">crop_scale</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">min_crop_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Init</span><span class="p">(</span><span class="n">crop_scale</span><span class="p">,</span><span class="w"> </span><span class="n">min_crop_size</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>CropBoxWholeImage根据指定的长、宽裁切图片，如果红绿灯在指定的长、宽之内，则返回裁切框。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CropBoxWholeImage::getCropBox</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="w"> </span><span class="o">&amp;</span><span class="n">light</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">base</span><span class="o">::</span><span class="n">RectI</span><span class="w"> </span><span class="o">*</span><span class="n">crop_box</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 红绿灯在裁剪范围（给定长、宽）内</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">OutOfValidRegion</span><span class="p">(</span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">Area</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 2. 否则返回全0</span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>裁切图片。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CropBox::getCropBox</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="w"> </span><span class="o">&amp;</span><span class="n">light</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">base</span><span class="o">::</span><span class="n">RectI</span><span class="w"> </span><span class="o">*</span><span class="n">crop_box</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 如果超出范围，则返回0</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutOfValidRegion</span><span class="p">(</span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">Area</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 2. 获取灯的感兴趣区域</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">xl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">yt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">xr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">yb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// scale</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">center_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">xr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xl</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">center_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">yb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">yt</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 3. 感兴趣区域的2.5倍，crop_scale_为裁切比例</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">resize</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">crop_scale_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="w"></span>
<span class="w">                                         </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">projection_roi</span><span class="p">.</span><span class="n">height</span><span class="p">)));</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 4. 根据裁切比例和长、宽，取最小值</span>
<span class="w">  </span><span class="n">resize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">resize</span><span class="p">,</span><span class="w"> </span><span class="n">min_crop_size_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">resize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">resize</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">resize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">resize</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 5. 计算并且赋值</span>
<span class="w">  </span><span class="n">xl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">center_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">xl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">xl</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">xl</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">yt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">center_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">yt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">yt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">yt</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">xr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">yb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xr</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">xl</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">xr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">xr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">yb</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">yt</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">yb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">yb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xl</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yt</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">crop_box</span><span class="o">-&gt;</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">yt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>疑问</strong></p>
<ol class="arabic simple">
<li><p>第5步中的实现逻辑是什么样？？？</p></li>
</ol>
<p>“select.h”和”select.cc”选择红绿灯。<br />
首先看Select类的数据结构，其中用到了匈牙利优化器？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">common</span><span class="o">::</span><span class="n">HungarianOptimizer</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">munkres_</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>初始化</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">Select::Init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rows</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">munkres_</span><span class="p">.</span><span class="n">costs</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Reserve</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="n">cols</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>疑问</strong></p>
<ol class="arabic simple">
<li><p>优化器的cost为什么需要行和列数据？</p></li>
</ol>
<p>计算高斯分数？？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="nf">Select::Calc2dGaussianScore</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">Point2DI</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Point2DI</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="kt">float</span><span class="w"> </span><span class="n">sigma1</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sigma2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exp</span><span class="p">(</span><span class="mf">-0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">((</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                              </span><span class="p">(</span><span class="n">sigma1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigma1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                          </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">((</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                           </span><span class="p">(</span><span class="n">sigma2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigma2</span><span class="p">))));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>选择红绿灯。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Select::SelectTrafficLights</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">refined_bboxes</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">assignments</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">munkres_</span><span class="p">.</span><span class="n">costs</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Resize</span><span class="p">(</span><span class="n">hdmap_bboxes</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hdmap_bboxes</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">center_hd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)[</span><span class="n">row</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">detection_roi</span><span class="p">.</span><span class="n">Center</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)[</span><span class="n">row</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">outside_image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;projection_roi outside image, set score to 0.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">munkres_</span><span class="p">.</span><span class="n">costs</span><span class="p">())(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">gaussian_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">center_refine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">detection_roi</span><span class="p">.</span><span class="n">Center</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="c1">// use gaussian score as metrics of distance and width</span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">distance_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Calc2dGaussianScore</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">center_hd</span><span class="p">,</span><span class="w"> </span><span class="n">center_refine</span><span class="p">,</span><span class="w"> </span><span class="n">gaussian_score</span><span class="p">,</span><span class="w"> </span><span class="n">gaussian_score</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">max_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">detect_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">detect_score</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">detection_score</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">detect_score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_score</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">max_score</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">detect_score</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">distance_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">detection_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">distance_weight</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="o">*</span><span class="n">munkres_</span><span class="p">.</span><span class="n">costs</span><span class="p">())(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">detection_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">detection_score</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                             </span><span class="n">distance_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">distance_score</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">crop_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)[</span><span class="n">row</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">crop_roi</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">detection_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">detection_roi</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// 1. crop roi在detection roi之外</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">detection_roi</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">crop_roi</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">detection_roi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">munkres_</span><span class="p">.</span><span class="n">costs</span><span class="p">())(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;score &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">munkres_</span><span class="p">.</span><span class="n">costs</span><span class="p">())(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="n">munkres_</span><span class="p">.</span><span class="n">Maximize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">assignments</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hdmap_bboxes</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">is_selected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">is_detected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 把结果放入hdmap_bbox_region</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">assignments</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">hdmap_bboxes</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">is_selected</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">refined_bboxes</span><span class="p">[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">.</span><span class="n">is_selected</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">refined_bbox_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bboxes</span><span class="p">[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hdmap_bbox_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">hdmap_bboxes</span><span class="p">)[</span><span class="n">assignments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">refined_bbox_region</span><span class="p">.</span><span class="n">is_selected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">is_selected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">crop_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">crop_roi</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">detection_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bbox_region</span><span class="p">.</span><span class="n">detection_roi</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">outside_crop_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">crop_roi</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">detection_roi</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">detection_roi</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">outside_image</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">outside_crop_roi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">is_detected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">detection_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bbox_region</span><span class="p">.</span><span class="n">detection_roi</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">detect_class_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bbox_region</span><span class="p">.</span><span class="n">detect_class_id</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">detect_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bbox_region</span><span class="p">.</span><span class="n">detect_score</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">is_detected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bbox_region</span><span class="p">.</span><span class="n">is_detected</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">hdmap_bbox_region</span><span class="p">.</span><span class="n">is_selected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refined_bbox_region</span><span class="p">.</span><span class="n">is_selected</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>疑问</strong><br />
功能如何实现的？有什么作用？</p>
<p>接下来我们看”detection.h”和”detection.cc”。首先看一下”TrafficLightDetection”类的参数。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">traffic_light</span><span class="o">::</span><span class="n">detection</span><span class="o">::</span><span class="n">DetectionParam</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">DataProvider</span><span class="o">::</span><span class="n">ImageOptions</span><span class="w"> </span><span class="n">data_provider_image_option_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">inference</span><span class="o">::</span><span class="n">Inference</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rt_net_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Image8U</span><span class="o">&gt;</span><span class="w"> </span><span class="n">image_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Blob</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">param_blob_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Blob</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mean_buffer_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">IGetBox</span><span class="o">&gt;</span><span class="w"> </span><span class="n">crop_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">detected_bboxes_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">selected_bboxes_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">net_inputs_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">net_outputs_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Select</span><span class="w"> </span><span class="n">select_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">max_batch_size_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">param_blob_length_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">mean_</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">RectI</span><span class="o">&gt;</span><span class="w"> </span><span class="n">crop_box_list_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resize_scale_list_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">gpu_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Init初始化。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TrafficLightDetection::Init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">camera</span><span class="o">::</span><span class="n">TrafficLightDetectorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">proto_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 获取检测参数</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">proto_path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">detection_param_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load proto param failed, root dir: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">param_str</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">TextFormat</span><span class="o">::</span><span class="n">PrintToString</span><span class="p">(</span><span class="n">detection_param_</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param_str</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;TL detection param: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">param_str</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">model_root</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">model_name</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;model_root &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">model_root</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">proto_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">model_root</span><span class="p">,</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">proto_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;proto_file &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">proto_file</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">weight_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">model_root</span><span class="p">,</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">weight_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;weight_file &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">weight_file</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">detection_param_</span><span class="p">.</span><span class="n">is_bgr</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">data_provider_image_option_</span><span class="p">.</span><span class="n">target_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Color</span><span class="o">::</span><span class="n">BGR</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">mean_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">mean_b</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">mean_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">mean_g</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">mean_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">mean_r</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">data_provider_image_option_</span><span class="p">.</span><span class="n">target_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Color</span><span class="o">::</span><span class="n">RGB</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">mean_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">mean_r</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">mean_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">mean_g</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">mean_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">mean_b</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">net_inputs_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">detection_param_</span><span class="p">.</span><span class="n">input_blob_name</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">net_inputs_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">detection_param_</span><span class="p">.</span><span class="n">im_param_blob_name</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">net_outputs_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">detection_param_</span><span class="p">.</span><span class="n">output_blob_name</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;net input blobs: &quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">net_inputs_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">net_inputs_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">                           </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                           </span><span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                             </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="w">                           </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;net output blobs: &quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">net_outputs_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">net_outputs_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">                           </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                           </span><span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                             </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="w">                           </span><span class="p">});</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">model_type</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;model_type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">model_type</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">rt_net_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">inference</span><span class="o">::</span><span class="n">CreateInferenceByName</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span><span class="w"> </span><span class="n">proto_file</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">weight_file</span><span class="p">,</span><span class="w"> </span><span class="n">net_outputs_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">net_inputs_</span><span class="p">,</span><span class="w"> </span><span class="n">model_root</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;rt_net_ create succeed&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">rt_net_</span><span class="o">-&gt;</span><span class="n">set_gpu_id</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">gpu_id</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;set gpu id &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">gpu_id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">gpu_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">gpu_id</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">min_crop_size</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">min_crop_size</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">max_batch_size_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">max_batch_size</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">param_blob_length_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">CHECK_GT</span><span class="p">(</span><span class="n">resize_height</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">CHECK_GT</span><span class="p">(</span><span class="n">resize_width</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">CHECK_GT</span><span class="p">(</span><span class="n">max_batch_size_</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shape_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">max_batch_size_</span><span class="p">,</span><span class="w"> </span><span class="n">resize_height</span><span class="p">,</span><span class="w"> </span><span class="n">resize_width</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="mi">3</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shape_param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">max_batch_size_</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">param_blob_length_</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">input_reshape</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">input_reshape</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">net_inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">shape_input</span><span class="p">)));</span><span class="w"></span>
<span class="w">  </span><span class="n">input_reshape</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">net_inputs_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">shape_param</span><span class="p">)));</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rt_net_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">input_reshape</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;net init fail.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;net init success.&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">mean_buffer_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Blob</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">resize_height</span><span class="p">,</span><span class="w"> </span><span class="n">resize_height</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="n">param_blob_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt_net_</span><span class="o">-&gt;</span><span class="n">get_blob</span><span class="p">(</span><span class="n">net_inputs_</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">param_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_blob_</span><span class="o">-&gt;</span><span class="n">mutable_cpu_data</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_batch_size_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">param_blob_length_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">param_data</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">resize_width</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">param_data</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">resize_height</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">param_data</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">param_data</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">param_data</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">param_data</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">detection_param_</span><span class="p">.</span><span class="n">crop_method</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">crop_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CropBox</span><span class="p">(</span><span class="n">detection_param_</span><span class="p">.</span><span class="n">crop_scale</span><span class="p">(),</span><span class="w"></span>
<span class="w">                              </span><span class="n">detection_param_</span><span class="p">.</span><span class="n">min_crop_size</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">crop_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CropBoxWholeImage</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">select_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">resize_width</span><span class="p">,</span><span class="w"> </span><span class="n">resize_height</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">image_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Image8U</span><span class="p">(</span><span class="n">resize_height</span><span class="p">,</span><span class="w"> </span><span class="n">resize_width</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Color</span><span class="o">::</span><span class="n">BGR</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="tracker">
<h2>tracker 追踪<a class="headerlink" href="#tracker" title="Permalink to this headline"></a></h2>
<p>追踪功能在”SemanticReviser”类中实现的。先看下”SemanticReviser”类中的参数。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">traffic_light</span><span class="o">::</span><span class="n">tracker</span><span class="o">::</span><span class="n">SemanticReviseParam</span><span class="w"> </span><span class="n">semantic_param_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 修订时间</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">revise_time_s_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 2. 闪烁阈值</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">blink_threshold_s_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.4f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 3. 不闪烁阈值</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">non_blink_threshold_s_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.8f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 4. 滞后阈值</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">hysteretic_threshold_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 5. 历史语义</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SemanticTable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">history_semantic_</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>接着看下”SemanticTable”结构，后面会用到。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">SemanticTable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">last_bright_time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">last_dark_time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">blink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">semantic</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">light_ids</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="w"> </span><span class="n">color</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">HystereticWindow</span><span class="w"> </span><span class="n">hystertic_window</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="init">
<h2>Init初始化<a class="headerlink" href="#init" title="Permalink to this headline"></a></h2>
<p>从配置文件中读取参数，其中”non_blink_threshold_s_”是”blink_threshold_s_”参数的2倍。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">SemanticReviser::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TrafficLightTrackerInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">proto_path</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">proto_path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">semantic_param_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load proto param failed, root dir: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">non_blink_coef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">revise_time_s_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semantic_param_</span><span class="p">.</span><span class="n">revise_time_second</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">blink_threshold_s_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semantic_param_</span><span class="p">.</span><span class="n">blink_threshold_second</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">hysteretic_threshold_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semantic_param_</span><span class="p">.</span><span class="n">hysteretic_threshold_count</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">non_blink_threshold_s_</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">blink_threshold_s_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">non_blink_coef</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="track">
<h2>Track 追踪<a class="headerlink" href="#track" title="Permalink to this headline"></a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">SemanticReviser::Track</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TrafficLightTrackerOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lights_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">traffic_lights</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SemanticTable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 1. 如果没有红绿灯，则退出修订</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lights_ref</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">history_semantic_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;no lights to revise, return&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 遍历红绿灯，找到发生变化的表</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lights_ref</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lights_ref</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cur_semantic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">semantic</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">SemanticTable</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur_semantic</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Semantic_&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cur_semantic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;No_semantic_light_&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">tmp</span><span class="p">.</span><span class="n">semantic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">tmp</span><span class="p">.</span><span class="n">light_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">tmp</span><span class="p">.</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">color</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">tmp</span><span class="p">.</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">tmp</span><span class="p">.</span><span class="n">blink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">semantic_table</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">semantic_table</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">compare</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">light_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 3. 更新红绿灯序列</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SemanticTable</span><span class="w"> </span><span class="n">cur_semantic_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ReviseByTimeSeries</span><span class="p">(</span><span class="n">time_stamp</span><span class="p">,</span><span class="w"> </span><span class="n">cur_semantic_table</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lights_ref</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>根据时间序列更新红绿灯的状态。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">SemanticReviser::ReviseByTimeSeries</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">,</span><span class="w"> </span><span class="n">SemanticTable</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lights_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="w"> </span><span class="n">cur_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReviseBySemantic</span><span class="p">(</span><span class="n">semantic_table</span><span class="p">,</span><span class="w"> </span><span class="n">lights</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="w"> </span><span class="n">pre_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_UNKNOWN_COLOR</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_color</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;revise same semantic lights&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ReviseLights</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">light_ids</span><span class="p">,</span><span class="w"> </span><span class="n">cur_color</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SemanticTable</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">history_semantic_</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">history_semantic_</span><span class="p">),</span><span class="w"></span>
<span class="w">                   </span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">compare</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">history_semantic_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pre_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">revise_time_s_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;revise by time series&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">cur_color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_YELLOW</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_RED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ReviseLights</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">light_ids</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">UpdateHistoryAndLights</span><span class="p">(</span><span class="n">semantic_table</span><span class="p">,</span><span class="w"> </span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;High confidence color &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_color_strs</span><span class="p">[</span><span class="n">cur_color</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_RED</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_GREEN</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="n">UpdateHistoryAndLights</span><span class="p">(</span><span class="n">semantic_table</span><span class="p">,</span><span class="w"> </span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">last_bright_time_stamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">blink_threshold_s_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">last_dark_time_stamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">last_bright_time_stamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">blink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">last_bright_time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;High confidence color &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_color_strs</span><span class="p">[</span><span class="n">cur_color</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_BLACK</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">last_dark_time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_UNKNOWN_COLOR</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_BLACK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">UpdateHistoryAndLights</span><span class="p">(</span><span class="n">semantic_table</span><span class="p">,</span><span class="w"> </span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ReviseLights</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">light_ids</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_UNKNOWN_COLOR</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="n">ReviseLights</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">light_ids</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_color</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// set blink status</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pre_color</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">fabs</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">last_dark_time_stamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">last_bright_time_stamp</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">non_blink_threshold_s_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">blink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">light_ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">lights_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">blink</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">blink</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_GREEN</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">last_dark_time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">last_bright_time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">history_semantic_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">semantic_table</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>修改红绿灯为目标颜色。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">SemanticReviser::ReviseLights</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">light_ids</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="w"> </span><span class="n">dst_color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 遍历红绿灯数组，并且修改颜色为dst_color</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">light_ids</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lights</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dst_color</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>通过语义判别红绿灯颜色。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="w"> </span><span class="nf">SemanticReviser::ReviseBySemantic</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">SemanticTable</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vote</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_TOTAL_COLOR_NUM</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lights_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="w"> </span><span class="n">max_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_UNKNOWN_COLOR</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 1. 遍历红绿灯，把出现的颜色放入投票桶</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">light_ids</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semantic_table</span><span class="p">.</span><span class="n">light_ids</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lights_ref</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">light</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">color</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">vote</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">color</span><span class="p">))</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// 2.如果红绿灯红、黄、绿的颜色为0</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">vote</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_RED</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">vote</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_GREEN</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">vote</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_YELLOW</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 3. 红绿灯黑色的次数大于0</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vote</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_BLACK</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_BLACK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_UNKNOWN_COLOR</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">vote</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_BLACK</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">vote</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_UNKNOWN_COLOR</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 4. 找到最多出现的次数</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">biggest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max_element</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">vote</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">vote</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">max_color_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">biggest</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">max_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">vote</span><span class="p">),</span><span class="w"> </span><span class="n">biggest</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="n">vote</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">biggest</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 5. 找到出现第二多的次数</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">second_biggest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max_element</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">vote</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">vote</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 6. 如果第一多和第二多的相等，则返回UNKNOWN</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max_color_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">*</span><span class="n">second_biggest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_UNKNOWN_COLOR</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 7. 返回出现最多的颜色</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">max_color</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>更新历史记录。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">SemanticReviser::UpdateHistoryAndLights</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SemanticTable</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">lights</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SemanticTable</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="n">time_stamp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">TLColor</span><span class="o">::</span><span class="n">TL_BLACK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_count</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="n">color</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">hysteretic_threshold_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="n">color</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hystertic_window</span><span class="p">.</span><span class="n">hysteretic_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Black lights hysteretic change to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s_color_strs</span><span class="p">[</span><span class="n">cur</span><span class="p">.</span><span class="n">color</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ReviseLights</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="n">light_ids</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">.</span><span class="n">color</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="obstacle">
<h1>obstacle障碍物<a class="headerlink" href="#obstacle" title="Permalink to this headline"></a></h1>
<p>首先obstacle的目录结构如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── detector    // 检测
├── postprocessor  // 后处理？做了什么处理???
├── tracker  // 追踪
└── transformer  // 坐标转换
</pre></div>
</div>
<p>下面我们分别分析下每个模块具体的实现。</p>
</div>
<div class="section" id="id1">
<h1>detector检测<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p>障碍物检测用到的是YOLO深度学习模型，下面我们看下YoloObstacleDetector类的实现。<br />
初始化Yolo网络</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">YoloObstacleDetector::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleDetectorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">gpu_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">gpu_id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">BASE_CUDA_CHECK</span><span class="p">(</span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="n">gpu_id_</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">BASE_CUDA_CHECK</span><span class="p">(</span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream_</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="n">base_camera_model_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">base_camera_model</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">base_camera_model_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;base_camera_model is nullptr!&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">config_path</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">yolo_param_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;read proto_config fail&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model_param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolo_param_</span><span class="p">.</span><span class="n">model_param</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">model_root</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">model_param</span><span class="p">.</span><span class="n">model_name</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">anchors_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">model_root</span><span class="p">,</span><span class="w"> </span><span class="n">model_param</span><span class="p">.</span><span class="n">anchors_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">types_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">model_root</span><span class="p">,</span><span class="w"> </span><span class="n">model_param</span><span class="p">.</span><span class="n">types_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">expand_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">model_root</span><span class="p">,</span><span class="w"> </span><span class="n">model_param</span><span class="p">.</span><span class="n">expand_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">LoadInputShape</span><span class="p">(</span><span class="n">model_param</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">LoadParam</span><span class="p">(</span><span class="n">yolo_param_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">min_dims_</span><span class="p">.</span><span class="n">min_2d_height</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">height_</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LoadAnchors</span><span class="p">(</span><span class="n">anchors_file</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">anchors_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LoadTypes</span><span class="p">(</span><span class="n">types_file</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">types_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LoadExpand</span><span class="p">(</span><span class="n">expand_file</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">expands_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">expands_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">types_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">InitNet</span><span class="p">(</span><span class="n">yolo_param_</span><span class="p">,</span><span class="w"> </span><span class="n">model_root</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">InitYoloBlob</span><span class="p">(</span><span class="n">yolo_param_</span><span class="p">.</span><span class="n">net_param</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">InitFeatureExtractor</span><span class="p">(</span><span class="n">model_root</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>特征提取采用的是”TrackingFeatureExtractor”</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">YoloObstacleDetector::InitFeatureExtractor</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">root_dir</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">FeatureExtractorInitOptions</span><span class="w"> </span><span class="n">feat_options</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">conf_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolo_param_</span><span class="p">.</span><span class="n">model_param</span><span class="p">().</span><span class="n">feature_file</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">root_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root_dir</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">gpu_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpu_id_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">feat_blob_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolo_param_</span><span class="p">.</span><span class="n">net_param</span><span class="p">().</span><span class="n">feat_blob</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">feat_blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">get_blob</span><span class="p">(</span><span class="n">feat_blob_name</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">input_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">input_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feature_extractor_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">BaseFeatureExtractorRegisterer</span><span class="o">::</span><span class="n">GetInstanceByName</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;TrackingFeatureExtractor&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">feature_extractor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">feat_options</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>下面我们再看下如何用YOLO做目标检测。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">YoloObstacleDetector::Detect</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleDetectorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 设置GPU设备</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="n">gpu_id_</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">input_blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">get_blob</span><span class="p">(</span><span class="n">yolo_param_</span><span class="p">.</span><span class="n">net_param</span><span class="p">().</span><span class="n">input_blob</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="n">DataProvider</span><span class="o">::</span><span class="n">ImageOptions</span><span class="w"> </span><span class="n">image_options</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">image_options</span><span class="p">.</span><span class="n">target_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Color</span><span class="o">::</span><span class="n">BGR</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">image_options</span><span class="p">.</span><span class="n">crop_roi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">RectI</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">offset_y_</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base_camera_model_</span><span class="o">-&gt;</span><span class="n">get_width</span><span class="p">()),</span><span class="w"></span>
<span class="w">      </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base_camera_model_</span><span class="o">-&gt;</span><span class="n">get_height</span><span class="p">())</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset_y_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">image_options</span><span class="p">.</span><span class="n">do_crop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">GetImage</span><span class="p">(</span><span class="n">image_options</span><span class="p">,</span><span class="w"> </span><span class="n">image_</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="n">inference</span><span class="o">::</span><span class="n">ResizeGPU</span><span class="p">(</span><span class="o">*</span><span class="n">image_</span><span class="p">,</span><span class="w"> </span><span class="n">input_blob</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="p">(),</span><span class="w"></span>
<span class="w">                       </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>


<span class="w">  </span><span class="c1">// 2. 检测</span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">Infer</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">get_objects_gpu</span><span class="p">(</span><span class="n">yolo_blobs_</span><span class="p">,</span><span class="w"> </span><span class="n">stream_</span><span class="p">,</span><span class="w"> </span><span class="n">types_</span><span class="p">,</span><span class="w"> </span><span class="n">nms_</span><span class="p">,</span><span class="w"> </span><span class="n">yolo_param_</span><span class="p">.</span><span class="n">model_param</span><span class="p">(),</span><span class="w"></span>
<span class="w">                  </span><span class="n">light_vis_conf_threshold_</span><span class="p">,</span><span class="w"> </span><span class="n">light_swt_conf_threshold_</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">overlapped_</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">idx_sm_</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">));</span><span class="w"></span>


<span class="w">  </span><span class="n">filter_bbox</span><span class="p">(</span><span class="n">min_dims_</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">FeatureExtractorOptions</span><span class="w"> </span><span class="n">feat_options</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">feature_extractor_</span><span class="o">-&gt;</span><span class="n">Extract</span><span class="p">(</span><span class="n">feat_options</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">recover_bbox</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="p">(),</span><span class="w"></span>
<span class="w">               </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset_y_</span><span class="p">,</span><span class="w"> </span><span class="n">offset_y_</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 3. 后处理</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">left_boundary</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">border_ratio_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image_</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">right_boundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">((</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">border_ratio_</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                                        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image_</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">obj</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recover alpha</span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">alpha</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">ori_cycle_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// get area_id from visible_ratios</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">yolo_param_</span><span class="p">.</span><span class="n">model_param</span><span class="p">().</span><span class="n">num_areas</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">area_id</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">get_area_id</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">visible_ratios</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// clear cut off ratios</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">box</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">xmin</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">left_boundary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">cut_off_ratios</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">xmax</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">right_boundary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">cut_off_ratios</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>其中推理过程有GPU实现也有CPU实现。 通过”get_objects_gpu”获取物体的信息。</p>
</div>
<div class="section" id="id2">
<h1>tracker追踪<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h1>
<p>tracker追踪在”OMTObstacleTracker”类中实现。<br />
初始化Init</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">OMTObstacleTracker::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleTrackerInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">omt_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 加载omt配置</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">omt_config</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">omt_param_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Read config failed: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_config</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load omt parameters from &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_config</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">img_capability: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">img_capability</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">lost_age: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">lost_age</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">reserve_age: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">reserve_age</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">border: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">border</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">target_thresh: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">target_thresh</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">correct_type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">correct_type</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 初始化参数</span>
<span class="w">  </span><span class="n">track_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">frame_num_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">frame_list_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">omt_param_</span><span class="p">.</span><span class="n">img_capability</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">gpu_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">gpu_id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">similar_map_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">omt_param_</span><span class="p">.</span><span class="n">img_capability</span><span class="p">(),</span><span class="w"> </span><span class="n">gpu_id_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">similar_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">GPUSimilar</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">width_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">image_width</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">height_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">image_height</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">reference_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">omt_param_</span><span class="p">.</span><span class="n">reference</span><span class="p">(),</span><span class="w"> </span><span class="n">width_</span><span class="p">,</span><span class="w"> </span><span class="n">height_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">type_change_cost</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">type_change_cost</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="n">fin</span><span class="p">(</span><span class="n">type_change_cost</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">fin</span><span class="p">.</span><span class="n">is_open</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">kTypeAssociatedCost_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">n_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">MAX_OBJECT_TYPE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_type</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">kTypeAssociatedCost_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n_type</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_type</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">fin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kTypeAssociatedCost_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">targets_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">used_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Init object template</span>
<span class="w">  </span><span class="n">object_template_manager_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectTemplateManager</span><span class="o">::</span><span class="n">Instance</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>计算运动相似度</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="nf">OMTObstacleTracker::ScoreMotion</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">TrackObjectPtr</span><span class="w"> </span><span class="n">track_obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">image_center</span><span class="p">.</span><span class="n">get_state</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">target_centerx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">target_centery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">Point2DF</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">track_obj</span><span class="o">-&gt;</span><span class="n">projected_box</span><span class="p">.</span><span class="n">Center</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">RectF</span><span class="w"> </span><span class="n">rect</span><span class="p">(</span><span class="n">track_obj</span><span class="o">-&gt;</span><span class="n">projected_box</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gaussian</span><span class="p">(</span><span class="n">center</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">target_centerx</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">            </span><span class="n">gaussian</span><span class="p">(</span><span class="n">center</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">target_centery</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>计算形状相似度</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="nf">OMTObstacleTracker::ScoreShape</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">TrackObjectPtr</span><span class="w"> </span><span class="n">track_obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">image_wh</span><span class="p">.</span><span class="n">get_state</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">RectF</span><span class="w"> </span><span class="n">rect</span><span class="p">(</span><span class="n">track_obj</span><span class="o">-&gt;</span><span class="n">projected_box</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                               </span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>计算显示相似度</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="nf">OMTObstacleTracker::ScoreAppearance</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">TrackObjectPtr</span><span class="w"> </span><span class="n">track_obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">sensor_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">track_obj</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">sensor_name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">sensor_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">sensor_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">PatchIndicator</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">PatchIndicator</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">track_obj</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">energy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">similar_map_</span><span class="p">.</span><span class="n">sim</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.9f</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>计算重叠相似度</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="nf">OMTObstacleTracker::ScoreOverlap</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">TrackObjectPtr</span><span class="w"> </span><span class="n">track_obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">image_center</span><span class="p">.</span><span class="n">get_state</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">wh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">image_wh</span><span class="p">.</span><span class="n">get_state</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">BBox2DF</span><span class="w"> </span><span class="n">box_target</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">box_target</span><span class="p">.</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">box_target</span><span class="p">.</span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">box_target</span><span class="p">.</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">box_target</span><span class="p">.</span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">box_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">track_obj</span><span class="o">-&gt;</span><span class="n">projected_box</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">iou</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">CalculateIOUBBox</span><span class="p">(</span><span class="n">box_target</span><span class="p">,</span><span class="w"> </span><span class="n">box_obj</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">iou</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>找到最匹配的障碍物。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">OMTObstacleTracker::GenerateHypothesis</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TrackObjectPtrs</span><span class="w"> </span><span class="o">&amp;</span><span class="n">objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Hypothesis</span><span class="o">&gt;</span><span class="w"> </span><span class="n">score_list</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Hypothesis</span><span class="w"> </span><span class="n">hypo</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Target &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">hypo</span><span class="p">.</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">hypo</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ScoreAppearance</span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">sm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ScoreMotion</span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ScoreShape</span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ScoreOverlap</span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">hypo</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">weight_diff_camera</span><span class="p">().</span><span class="n">motion</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sm</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                     </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">weight_diff_camera</span><span class="p">().</span><span class="n">shape</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                     </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">weight_diff_camera</span><span class="p">().</span><span class="n">overlap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">so</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">hypo</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">omt_param_</span><span class="p">.</span><span class="n">weight_same_camera</span><span class="p">().</span><span class="n">appearance</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                      </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">weight_same_camera</span><span class="p">().</span><span class="n">motion</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sm</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                      </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">weight_same_camera</span><span class="p">().</span><span class="n">shape</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                      </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">weight_same_camera</span><span class="p">().</span><span class="n">overlap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">so</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">change_from_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">change_to_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">sub_type</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">hypo</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">-</span><span class="n">kTypeAssociatedCost_</span><span class="p">[</span><span class="n">change_from_type</span><span class="p">][</span><span class="n">change_to_type</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Detection &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">frame_id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">j</span><span class="w"></span>
<span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;) sa:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; sm: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sm</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ss: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; so: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">so</span><span class="w"></span>
<span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; score: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">hypo</span><span class="p">.</span><span class="n">score</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// 95.44% area is range [mu - sigma*2, mu + sigma*2]</span>
<span class="w">      </span><span class="c1">// don&#39;t match if motion is beyond the range</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.045</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">hypo</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">target_thresh</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">score_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hypo</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">sort</span><span class="p">(</span><span class="n">score_list</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">score_list</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">greater</span><span class="o">&lt;</span><span class="n">Hypothesis</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">used_target</span><span class="p">(</span><span class="n">targets_</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">score_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">used_target</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">used_</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">det_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">target</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">det_obj</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">used_</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">used_target</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Target &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; match &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">det_obj</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">frame_id</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;at &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; size: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>合并重复的障碍物</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">OMTObstacleTracker::CombineDuplicateTargets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Hypothesis</span><span class="o">&gt;</span><span class="w"> </span><span class="n">score_list</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Hypothesis</span><span class="w"> </span><span class="n">hypo</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. targets_为数组，数组元素为Target类</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">index1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">index2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">index1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">index2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">index1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">index2</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p2</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">            </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">same_ts_eps</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">sensor_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">p2</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">sensor_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">box1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">projected_box</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">box2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2</span><span class="o">-&gt;</span><span class="n">projected_box</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">CalculateIOUBBox</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span><span class="w"> </span><span class="n">box2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">base</span><span class="o">::</span><span class="n">RectF</span><span class="w"> </span><span class="n">rect1</span><span class="p">(</span><span class="n">box1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">base</span><span class="o">::</span><span class="n">RectF</span><span class="w"> </span><span class="n">rect2</span><span class="p">(</span><span class="n">box2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">((</span><span class="n">rect1</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rect2</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                              </span><span class="p">(</span><span class="n">rect1</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rect2</span><span class="p">.</span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                              </span><span class="p">(</span><span class="n">rect1</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rect1</span><span class="p">.</span><span class="n">height</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="o">++</span><span class="n">index1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="o">++</span><span class="n">index2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">p2</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="o">++</span><span class="n">index2</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="o">++</span><span class="n">index1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Overlap: (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">id</span><span class="w"></span>
<span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;) score &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; count &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">hypo</span><span class="p">.</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">hypo</span><span class="p">.</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">hypo</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hypo</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">target_combine_iou_threshold</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">score_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hypo</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">sort</span><span class="p">(</span><span class="n">score_list</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">score_list</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">greater</span><span class="o">&lt;</span><span class="n">Hypothesis</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">used_target</span><span class="p">(</span><span class="n">targets_</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">score_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">used_target</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">used_target</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targets_</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">].</span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">].</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">index1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">index2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target_save</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">index1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target_del</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targets_</span><span class="p">[</span><span class="n">index2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">target_del</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// no need to change track_id of all objects in target_del</span>
<span class="w">      </span><span class="n">target_save</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">target_del</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">target_save</span><span class="p">.</span><span class="n">tracked_objects</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">target_save</span><span class="p">.</span><span class="n">tracked_objects</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">TrackObjectPtr</span><span class="w"> </span><span class="n">object1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">TrackObjectPtr</span><span class="w"> </span><span class="n">object2</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">object1</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">frame_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">object2</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">frame_id</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">target_save</span><span class="p">.</span><span class="n">latest_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target_save</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target_del</span><span class="p">.</span><span class="n">latest_object</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">target_del</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Target &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">target_del</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; is merged into Target &quot;</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">target_save</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; with iou &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">score</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">used_target</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">object</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">used_target</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">target</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>预测</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">OMTObstacleTracker::Predict</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleTrackerOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">targets_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">target</span><span class="p">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">latest_object</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">proposed_objects</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>创建新目标</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">OMTObstacleTracker::CreateNewTarget</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TrackObjectPtrs</span><span class="w"> </span><span class="o">&amp;</span><span class="n">objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">TemplateMap</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kMinTemplateHWL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">MinTemplateHWL</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">RectF</span><span class="o">&gt;</span><span class="w"> </span><span class="n">target_rects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">targets_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="p">.</span><span class="n">isTracked</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">isLost</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">RectF</span><span class="w"> </span><span class="n">target_rect</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">-1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">target_rects</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">target_rect</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">created_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">used_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_covered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sub_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">sub_type</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">base</span><span class="o">::</span><span class="n">RectF</span><span class="w"> </span><span class="n">rect</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">min_tmplt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kMinTemplateHWL</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">sub_type</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutOfValidRegion</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">width_</span><span class="p">,</span><span class="w"> </span><span class="n">height_</span><span class="p">,</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">border</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">target_rect</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">target_rects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsCovered</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">target_rect</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4f</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">IsCoveredHorizon</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">target_rect</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">is_covered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_covered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">min_tmplt</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w">  </span><span class="c1">// unknown type</span>
<span class="w">          </span><span class="o">||</span><span class="w"> </span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">min_tmplt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">omt_param_</span><span class="p">.</span><span class="n">min_init_height_ratio</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Target</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">omt_param_</span><span class="p">.</span><span class="n">target_param</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">target</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">targets_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Target &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; is created by &quot;</span><span class="w"></span>
<span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">frame_id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (&quot;</span><span class="w"></span>
<span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">.</span><span class="n">patch_id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">created_count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">created_count</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="postprocessor">
<h1>postprocessor后处理<a class="headerlink" href="#postprocessor" title="Permalink to this headline"></a></h1>
<p>后处理的入口在”LocationRefinerObstaclePostprocessor”中，下面我们分析下具体实现。<br />
是否在ROI区域</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">is_in_roi</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">img_w</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">img_h</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="kt">float</span><span class="w"> </span><span class="n">h_down</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">img_h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_down</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">img_w_half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">img_w</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">slope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">img_w_half</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">img_h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_down</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">img_w_half</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">slope</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">img_w_half</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slope</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_down</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>LocationRefinerObstaclePostprocessor类，初始化Init</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">LocationRefinerObstaclePostprocessor::Init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ObstaclePostprocessorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">postprocessor_config</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 读取配置</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">postprocessor_config</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="o">&amp;</span><span class="n">location_refiner_param_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Read config failed: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">postprocessor_config</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// 2. 打印配置</span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Load postprocessor parameters from &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">postprocessor_config</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">min_dist_to_camera: &quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">location_refiner_param_</span><span class="p">.</span><span class="n">min_dist_to_camera</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">roi_h2bottom_scale: &quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">location_refiner_param_</span><span class="p">.</span><span class="n">roi_h2bottom_scale</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>处理过程</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">LocationRefinerObstaclePostprocessor::Process</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ObstaclePostprocessorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="w"> </span><span class="n">plane</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 校准服务是否有地平面</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">do_refinement_with_calibration_service</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">calibration_service</span><span class="o">-&gt;</span><span class="n">QueryGroundPlaneInCameraFrame</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plane</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;No valid ground plane in the service.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. </span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">query_plane</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">plane</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">plane</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">      </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">plane</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">plane</span><span class="p">(</span><span class="mi">3</span><span class="p">))};</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_k_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">camera_k_matrix</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">k_mat</span><span class="p">[</span><span class="n">i3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_k_matrix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 3. 相机K矩阵</span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Camera k matrix input to obstacle postprocessor: </span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_height</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 4. 初始化后处理过程</span>
<span class="w">  </span><span class="n">postprocessor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">k_mat</span><span class="p">,</span><span class="w"> </span><span class="n">width_image</span><span class="p">,</span><span class="w"> </span><span class="n">height_image</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ObjPostProcessorOptions</span><span class="w"> </span><span class="n">obj_postprocessor_options</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_valid_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 5. 遍历检测到的障碍物</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">obj</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">++</span><span class="n">nr_valid_obj</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 6. 获取物体的中心</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">2</span><span class="p">)};</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">ymin</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">ymax</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">bottom_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{(</span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">]};</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">h_down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">height_image</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                   </span><span class="n">location_refiner_param_</span><span class="p">.</span><span class="n">roi_h2bottom_scale</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 7. 是否在ROI中</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_in_rule_roi</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">is_in_roi</span><span class="p">(</span><span class="n">bottom_center</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">width_image</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">height_image</span><span class="p">),</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">h_down</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dist2camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISqrt</span><span class="p">(</span><span class="n">common</span><span class="o">::</span><span class="n">ISqr</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                                      </span><span class="n">common</span><span class="o">::</span><span class="n">ISqr</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dist2camera</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">location_refiner_param_</span><span class="p">.</span><span class="n">min_dist_to_camera</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">is_in_rule_roi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Pass for obstacle postprocessor.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)};</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">box_cent_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">image_point_low_center</span><span class="p">(</span><span class="n">box_cent_x</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">point_in_camera</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">camera_k_matrix</span><span class="p">.</span><span class="n">inverse</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">image_point_low_center</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">theta_ray</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atan2</span><span class="p">(</span><span class="n">point_in_camera</span><span class="p">.</span><span class="n">x</span><span class="p">(),</span><span class="w"> </span><span class="n">point_in_camera</span><span class="p">.</span><span class="n">z</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">theta_ray</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">alpha</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// enforce the ry to be in the range [-pi, pi)</span>
<span class="w">    </span><span class="c1">// 8. 射线的属性？？？</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">Constant</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;::</span><span class="n">PI</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rotation_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">PI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rotation_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// process</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">obj_postprocessor_options</span><span class="p">.</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">obj_postprocessor_options</span><span class="p">.</span><span class="n">check_lowerbound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">camera</span><span class="o">::</span><span class="n">LineSegment2D</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">line_seg</span><span class="p">(</span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"></span>
<span class="w">                                          </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">obj_postprocessor_options</span><span class="p">.</span><span class="n">line_segs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">line_seg</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">obj_postprocessor_options</span><span class="p">.</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">obj_postprocessor_options</span><span class="p">.</span><span class="n">ry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotation_y</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// refine with calibration service, support ground plane model currently</span>
<span class="w">    </span><span class="c1">// {0.0f, cos(tilt), -sin(tilt), -camera_ground_height}</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">obj_postprocessor_options</span><span class="p">.</span><span class="n">plane</span><span class="p">,</span><span class="w"> </span><span class="n">query_plane</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// changed to touching-ground center</span>
<span class="w">    </span><span class="n">object_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 9. 后处理包括地面</span>
<span class="w">    </span><span class="n">postprocessor_</span><span class="o">-&gt;</span><span class="n">PostProcessObjWithGround</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">obj_postprocessor_options</span><span class="p">,</span><span class="w"> </span><span class="n">object_center</span><span class="p">,</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rotation_y</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">object_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">z_diff_camera</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">object_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// fill back results</span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">camera2world_pose</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;diff on camera z: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">z_diff_camera</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj center from postprocessor: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">.</span><span class="n">transpose</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>对象后处理过程在”ObjPostProcessor”类中，下面我们看下它的具体实现。<br />
设置默认参数。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">ObjPostProcessorParams::set_default</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">max_nr_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">sampling_ratio_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">weight_iou</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">learning_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">learning_r_decay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">dist_far</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">15.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">shrink_ratio_iou</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">iou_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>后处理包括地面</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ObjPostProcessor::PostProcessObjWithGround</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ObjPostProcessorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">ry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">bbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">ry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">ry</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 软约束</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">adjust_soft</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">AdjustCenterWithGround</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">plane</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">dist_far</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">adjust_soft</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 硬约束</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">adjust_hard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PostRefineCenterWithGroundBoundary</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">plane</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">line_segs</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">options</span><span class="p">.</span><span class="n">check_lowerbound</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">adjust_soft</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">adjust_hard</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>通过地面调整中心？？？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ObjPostProcessor::AdjustCenterWithGround</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">bbox</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ry</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">plane</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">center</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">iou_ini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetProjectionScore</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iou_ini</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">iou_good</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// ini pos is not good enough</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">MIN_COST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">sampling_ratio_low</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">EPS_COST_DELTA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-1f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">WEIGHT_IOU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">weight_iou</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_ITERATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">max_nr_iter</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">lr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">learning_r</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">cost_pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLT_MAX</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">cost_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">center_input</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">center_test</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// std::cout &lt;&lt; &quot;start to update the center...&quot; &lt;&lt; std::endl;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">common</span><span class="o">::</span><span class="n">IProjectThroughIntrinsic</span><span class="p">(</span><span class="n">k_mat_</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">in_front</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IBackprojectPlaneIntersectionCanonical</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">k_mat_</span><span class="p">,</span><span class="w"> </span><span class="n">plane</span><span class="p">,</span><span class="w"> </span><span class="n">center_test</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_front</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">memcpy</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">center_input</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">iou_cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetProjectionScore</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">iou_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetProjectionScore</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center_test</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISqrt</span><span class="p">(</span><span class="n">common</span><span class="o">::</span><span class="n">ISqr</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">center_test</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                               </span><span class="n">common</span><span class="o">::</span><span class="n">ISqr</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">center_test</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">cost_cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">WEIGHT_IOU</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">iou_cur</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">iou_test</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// std::cout &lt;&lt; &quot;cost___ &quot; &lt;&lt; cost_cur &lt;&lt; &quot;@&quot; &lt;&lt; iter &lt;&lt; std::endl;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cost_cur</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cost_pre</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">cost_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cost_pre</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cost_cur</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cost_pre</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">cost_pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cost_cur</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">center_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">center_test</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="o">++</span><span class="n">iter</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_ITERATION</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cost_delta</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">EPS_COST_DELTA</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="n">cost_pre</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MIN_COST</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">lr</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">learning_r_decay</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">iou_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetProjectionScore</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iou_res</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iou_ini</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">shrink_ratio_iou</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">center_input</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>根据地面边界获取细化的中心？？？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ObjPostProcessor::PostRefineCenterWithGroundBoundary</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">plane</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LineSegment2D</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">line_seg_limits</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">center</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">check_lowerbound</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">truncated_on_bottom</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">height_</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"></span>
<span class="w">                     </span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">sampling_ratio_low</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">truncated_on_bottom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">iou_before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetProjectionScore</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_line_segs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">line_seg_limits</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">depth_pts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">pts_c</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x_pts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>

<span class="w">  </span><span class="n">GetDepthXPair</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">depth_pts</span><span class="p">,</span><span class="w"> </span><span class="n">x_pts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pts_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">dxdz_acc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">ratio_x_over_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_line_segs</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dxdz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">GetDxDzForCenterFromGroundLineSeg</span><span class="p">(</span><span class="n">line_seg_limits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">plane</span><span class="p">,</span><span class="w"> </span><span class="n">pts_c</span><span class="p">,</span><span class="w"> </span><span class="n">k_mat_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">width_</span><span class="p">,</span><span class="w"> </span><span class="n">height_</span><span class="p">,</span><span class="w"> </span><span class="n">ratio_x_over_z</span><span class="p">,</span><span class="w"> </span><span class="n">dxdz</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">check_lowerbound</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">dxdz_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dxdz</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">dxdz_acc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dxdz</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dxdz_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dxdz_acc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">iou_after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetProjectionScore</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iou_after</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iou_before</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">shrink_ratio_iou</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">dxdz_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">dxdz_acc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>获取深度信息？？？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">ObjPostProcessor::GetDepthXPair</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">hwl</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ry</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">depth_pts</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">x_pts</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">pts_c</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">y_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">w_half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">l_half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">x_cor</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">l_half</span><span class="p">,</span><span class="w"> </span><span class="n">l_half</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">l_half</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">l_half</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">z_cor</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">w_half</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">w_half</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">w_half</span><span class="p">,</span><span class="w"> </span><span class="n">w_half</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">pts</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x_cor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">z_cor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">x_cor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">z_cor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="w">                   </span><span class="n">x_cor</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">z_cor</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">x_cor</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">z_cor</span><span class="p">[</span><span class="mi">3</span><span class="p">]};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">rot</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">GenRotMatrix</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">rot</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">pt_proj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">pt_c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pts</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">save_pts_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pts_c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">common</span><span class="o">::</span><span class="n">IProjectThroughExtrinsic</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">,</span><span class="w"> </span><span class="n">pt_c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">common</span><span class="o">::</span><span class="n">IProjectThroughIntrinsic</span><span class="p">(</span><span class="n">k_mat_</span><span class="p">,</span><span class="w"> </span><span class="n">pt_c</span><span class="p">,</span><span class="w"> </span><span class="n">pt_proj</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">depth_pts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">x_pts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRound</span><span class="p">(</span><span class="n">pt_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">pt_proj</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y_proj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRound</span><span class="p">(</span><span class="n">pt_proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">pt_proj</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y_proj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">y_min</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">y_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_proj</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_pts_c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">i3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">pts_c</span><span class="p">[</span><span class="n">i3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">pts_c</span><span class="p">[</span><span class="n">i3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">pts_c</span><span class="p">[</span><span class="n">i3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">pt</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">y_min</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="transformer">
<h1>transformer转换<a class="headerlink" href="#transformer" title="Permalink to this headline"></a></h1>
<p>MultiCueObstacleTransformer类，实现对障碍物做转换。<br />
初始化Init</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">MultiCueObstacleTransformer::Init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleTransformerInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">transformer_config</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 获取参数</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">transformer_config</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">multicue_param_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Read config failed: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">transformer_config</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Load transformer parameters from &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">transformer_config</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">min dimension: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">multicue_param_</span><span class="p">.</span><span class="n">min_dimension_val</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\n</span><span class="s">do template search: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">multicue_param_</span><span class="p">.</span><span class="n">check_dimension</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 初始化对象模板</span>
<span class="w">  </span><span class="n">object_template_manager_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectTemplateManager</span><span class="o">::</span><span class="n">Instance</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>SetObjMapperOptions设置对象地图属性</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MultiCueObstacleTransformer::SetObjMapperOptions</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="w"> </span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="w"> </span><span class="n">camera_k_matrix</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width_image</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">height_image</span><span class="p">,</span><span class="w"> </span><span class="n">ObjMapperOptions</span><span class="w"> </span><span class="o">*</span><span class="n">obj_mapper_options</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">theta_ray</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// prepare bbox2d</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">ymin</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">ymax</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="c1">// input insanity check</span>
<span class="w">  </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">width_image</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">height_image</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// prepare dimension_hwl</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)};</span><span class="w"></span>

<span class="w">  </span><span class="c1">// prepare rotation_y</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">box_cent_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">image_point_low_center</span><span class="p">(</span><span class="n">box_cent_x</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">point_in_camera</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">camera_k_matrix</span><span class="p">.</span><span class="n">inverse</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">image_point_low_center</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">theta_ray</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atan2</span><span class="p">(</span><span class="n">point_in_camera</span><span class="p">.</span><span class="n">x</span><span class="p">(),</span><span class="w"> </span><span class="n">point_in_camera</span><span class="p">.</span><span class="n">z</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="n">theta_ray</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">alpha</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="w"> </span><span class="n">sub_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">sub_type</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// enforce rotation_y to be in the range [-pi, pi)</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">Constant</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;::</span><span class="n">PI</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rotation_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">PI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rotation_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PI</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">obj_mapper_options</span><span class="o">-&gt;</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">obj_mapper_options</span><span class="o">-&gt;</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj_mapper_options</span><span class="o">-&gt;</span><span class="n">ry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotation_y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">obj_mapper_options</span><span class="o">-&gt;</span><span class="n">is_veh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">VEHICLE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj_mapper_options</span><span class="o">-&gt;</span><span class="n">check_dimension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">multicue_param_</span><span class="p">.</span><span class="n">check_dimension</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">obj_mapper_options</span><span class="o">-&gt;</span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">MatchTemplates</span><span class="p">(</span><span class="n">sub_type</span><span class="p">,</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// 2D到3D转换</span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;#2D-to-3D for one obj:&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj pred ry:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rotation_y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj pred type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sub_type</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Bbox: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bbox2d</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>匹配模板，返回值type_min_vol_index的作用是什么？？？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">MultiCueObstacleTransformer::MatchTemplates</span><span class="p">(</span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="w"> </span><span class="n">sub_type</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">dimension_hwl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">TemplateMap</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kMinTemplateHWL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">MinTemplateHWL</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">TemplateMap</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kMidTemplateHWL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">MidTemplateHWL</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">TemplateMap</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kMaxTemplateHWL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">MaxTemplateHWL</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">min_dimension_val</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">TemplateIndex</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kLookUpTableMinVolumeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">LookUpTableMinVolumeIndex</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">sub_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 1. 交通锥</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">TRAFFICCONE</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">min_tmplt_cur_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kMinTemplateHWL</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">sub_type</span><span class="p">).</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">max_tmplt_cur_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kMaxTemplateHWL</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">sub_type</span><span class="p">).</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">max_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">min_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 2. 行人、自行车、摩托车</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">PEDESTRIAN</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">CYCLIST</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">MOTORCYCLIST</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">min_tmplt_cur_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kMinTemplateHWL</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">sub_type</span><span class="p">).</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">mid_tmplt_cur_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kMidTemplateHWL</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">sub_type</span><span class="p">).</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">max_tmplt_cur_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kMaxTemplateHWL</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">sub_type</span><span class="p">).</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">dh_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabsf</span><span class="p">(</span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">dh_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabsf</span><span class="p">(</span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mid_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">dh_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabsf</span><span class="p">(</span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">max_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">diff_hs</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">diff_hs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">dh_min</span><span class="p">,</span><span class="w"> </span><span class="n">min_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"></span>
<span class="w">      </span><span class="n">diff_hs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">dh_mid</span><span class="p">,</span><span class="w"> </span><span class="n">mid_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"></span>
<span class="w">      </span><span class="n">diff_hs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">dh_max</span><span class="p">,</span><span class="w"> </span><span class="n">max_tmplt_cur_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"></span>
<span class="w">      </span><span class="n">sort</span><span class="p">(</span><span class="n">diff_hs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">diff_hs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">           </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">           </span><span class="p">});</span><span class="w"></span>
<span class="w">      </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diff_hs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 3. 汽车</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">CAR</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">kLookUpTableMinVolumeIndex</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">TemplateIndex</span><span class="o">::</span><span class="n">CAR_MIN_VOLUME_INDEX</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">VAN</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">kLookUpTableMinVolumeIndex</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">TemplateIndex</span><span class="o">::</span><span class="n">VAN_MIN_VOLUME_INDEX</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 5. 卡车</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">TRUCK</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">kLookUpTableMinVolumeIndex</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">TemplateIndex</span><span class="o">::</span><span class="n">TRUCK_MIN_VOLUME_INDEX</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">BUS</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">kLookUpTableMinVolumeIndex</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">TemplateIndex</span><span class="o">::</span><span class="n">BUS_MIN_VOLUME_INDEX</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">min_dimension_val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">multicue_param_</span><span class="p">.</span><span class="n">min_dimension_val</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">common</span><span class="o">::</span><span class="n">IScale3</span><span class="p">(</span><span class="n">dimension_hwl</span><span class="p">,</span><span class="w"> </span><span class="n">multicue_param_</span><span class="p">.</span><span class="n">min_dimension_val</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                                           </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">min_dimension_val</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">type_min_vol_index</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>填充结果，设置物体的大小，朝向等信息。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MultiCueObstacleTransformer::FillResults</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rotation_y</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3d</span><span class="w"> </span><span class="n">camera2world_pose</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">theta_ray</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">object_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">local_center</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj id: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">track_id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">sub_type</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj ori dimension: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">object_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera2world_pose</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="w"> </span><span class="n">pos_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper_</span><span class="o">-&gt;</span><span class="n">get_position_uncertainty</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center_uncertainty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pos_var</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center_uncertainty</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pos_var</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center_uncertainty</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pos_var</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">theta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotation_y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">camera2world_pose</span><span class="p">.</span><span class="n">matrix</span><span class="p">().</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                         </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)));</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dir</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">theta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atan2</span><span class="p">(</span><span class="n">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"></span>
<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">theta_variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">((</span><span class="n">mapper_</span><span class="o">-&gt;</span><span class="n">get_orientation_var</span><span class="p">())(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">theta_ray</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Dimension hwl: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj ry:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rotation_y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj theta: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">theta</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Obj center from transformer: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">.</span><span class="n">transpose</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>转换</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">MultiCueObstacleTransformer::Transform</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleTransformerOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 相机k矩阵内参矩阵</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_k_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">camera_k_matrix</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">k_mat</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">k_mat</span><span class="p">[</span><span class="n">i3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_k_matrix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_height</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera2world_pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">camera2world_pose</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">mapper_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">k_mat</span><span class="p">,</span><span class="w"> </span><span class="n">width_image</span><span class="p">,</span><span class="w"> </span><span class="n">height_image</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">ObjMapperOptions</span><span class="w"> </span><span class="n">obj_mapper_options</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">object_center</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">rotation_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_transformed_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">obj</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 1. 设置对象字典属性</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">theta_ray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SetObjMapperOptions</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">camera_k_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">width_image</span><span class="p">,</span><span class="w"> </span><span class="n">height_image</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">obj_mapper_options</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">theta_ray</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 2. 执行</span>
<span class="w">    </span><span class="n">mapper_</span><span class="o">-&gt;</span><span class="n">Solve3dBbox</span><span class="p">(</span><span class="n">obj_mapper_options</span><span class="p">,</span><span class="w"> </span><span class="n">object_center</span><span class="p">,</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="o">&amp;</span><span class="n">rotation_y</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 3. 填充结果</span>
<span class="w">    </span><span class="n">FillResults</span><span class="p">(</span><span class="n">object_center</span><span class="p">,</span><span class="w"> </span><span class="n">dimension_hwl</span><span class="p">,</span><span class="w"> </span><span class="n">rotation_y</span><span class="p">,</span><span class="w"> </span><span class="n">camera2world_pose</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">theta_ray</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="o">++</span><span class="n">nr_transformed_obj</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">nr_transformed_obj</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="objmapper">
<h2>ObjMapper<a class="headerlink" href="#objmapper" title="Permalink to this headline"></a></h2>
<p>ObjMapper找到3D框</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ObjMapper::Solve3dBbox</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObjMapperOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"></span>
<span class="w">                            </span><span class="kt">float</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">ry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// set default value for variance</span>
<span class="w">  </span><span class="n">set_default_variance</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">var_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">var_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// get input from options</span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">bbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">ry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">ry</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">check_dimension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">check_dimension</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">type_min_vol_index</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// check input hwl insanity</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">is_veh</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">check_dimension</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kVehHwl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">VehHwl</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">tmplt_with_min_vol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kVehHwl</span><span class="p">[</span><span class="n">type_min_vol_index</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">min_tmplt_vol</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">tmplt_with_min_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tmplt_with_min_vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tmplt_with_min_vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">shrink_ratio_vol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISqr</span><span class="p">(</span><span class="n">sqrtf</span><span class="p">(</span><span class="n">params_</span><span class="p">.</span><span class="n">iou_high</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">shrink_ratio_vol</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">shrink_ratio_vol</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// float shrink_ratio_vol = sqrt(params_.iou_high);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">abnormal_h_veh</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_tmplt_vol</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shrink_ratio_vol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">memcpy</span><span class="p">(</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">tmplt_with_min_vol</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">hwl_tmplt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">hwl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">hwl</span><span class="p">[</span><span class="mi">2</span><span class="p">]};</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">tmplt_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">VehObjHwlBySearchTemplates</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">hwl_tmplt</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmplt_index</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">thres_min_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shrink_ratio_vol</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kNrDimPerTmplt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">NrDimPerTmplt</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">search_success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">thres_min_score</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_same_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">kNrDimPerTmplt</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tmplt_index</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">TemplateIndex</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kLookUpTableMinVolumeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">object_template_manager_</span><span class="o">-&gt;</span><span class="n">LookUpTableMinVolumeIndex</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_car_pred</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">type_min_vol_index</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">          </span><span class="n">kLookUpTableMinVolumeIndex</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">TemplateIndex</span><span class="o">::</span><span class="n">CAR_MIN_VOLUME_INDEX</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">hwl_is_reliable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">search_success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">is_same_type</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hwl_is_reliable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">hwl_tmplt</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_car_pred</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">tmplt_with_median_vol</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">tmplt_with_min_vol</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kNrDimPerTmplt</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">tmplt_with_median_vol</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// call 3d solver</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">Solve3dBboxGivenOneFullBboxDimensionOrientation</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// calculate variance for yaw &amp; z</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">yaw_score_mean</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">common</span><span class="o">::</span><span class="n">IMean</span><span class="p">(</span><span class="n">ry_score_</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ry_score_</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">yaw_score_sdv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISdv</span><span class="p">(</span><span class="n">ry_score_</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">yaw_score_mean</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ry_score_</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="n">var_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISqrt</span><span class="p">(</span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">yaw_score_sdv</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">eps_mapper</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">rz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">rz_ratio</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">nr_bins_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">params_</span><span class="p">.</span><span class="n">nr_bins_z</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nr_bins_z</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">score_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">dz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rz</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">nr_bins_z</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">z_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rz</span><span class="p">,</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">depth_min</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">z_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rz</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">count_z_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">z_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_start</span><span class="p">;</span><span class="w"> </span><span class="n">z_test</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">z_end</span><span class="p">;</span><span class="w"> </span><span class="n">z_test</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">center_test</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]};</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_test</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">center_test</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">common</span><span class="o">::</span><span class="n">IScale3</span><span class="p">(</span><span class="n">center_test</span><span class="p">,</span><span class="w"> </span><span class="n">sf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">score_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetProjectionScore</span><span class="p">(</span><span class="o">*</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">bbox</span><span class="p">,</span><span class="w"> </span><span class="n">hwl</span><span class="p">,</span><span class="w"> </span><span class="n">center_test</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">score_z</span><span class="p">[</span><span class="n">count_z_test</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score_test</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">z_score_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IMean</span><span class="p">(</span><span class="n">score_z</span><span class="p">,</span><span class="w"> </span><span class="n">count_z_test</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">z_score_sdv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISdv</span><span class="p">(</span><span class="n">score_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_score_mean</span><span class="p">,</span><span class="w"> </span><span class="n">count_z_test</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">var_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISqr</span><span class="p">(</span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">z_score_sdv</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">params_</span><span class="p">.</span><span class="n">eps_mapper</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="c1">// fill the position_uncertainty_ and orientation_variance_</span>
<span class="w">  </span><span class="n">orientation_variance_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_yaw</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">bbox_cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">focal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">k_mat_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k_mat_</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">sf_z_to_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabsf</span><span class="p">(</span><span class="n">bbox_cx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">k_mat_</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">IRec</span><span class="p">(</span><span class="n">focal</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">var_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">ISqr</span><span class="p">(</span><span class="n">sf_z_to_x</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">var_xz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf_z_to_x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">var_z</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">position_uncertainty_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">position_uncertainty_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_z</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">position_uncertainty_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">position_uncertainty_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var_xz</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">success</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="lane">
<h1>lane车道线<a class="headerlink" href="#lane" title="Permalink to this headline"></a></h1>
</div>
<div class="section" id="id3">
<h1>postprocessor 后处理<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h1>
<div class="section" id="process2d">
<h2>Process2D<a class="headerlink" href="#process2d" title="Permalink to this headline"></a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">DarkSCNNLanePostprocessor::Process2D</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">LanePostprocessorOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">CameraFrame</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 1. 拷贝检测到车道线数据到 lane_map</span>
<span class="w">  </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">lane_map</span><span class="p">(</span><span class="n">lane_map_height_</span><span class="p">,</span><span class="w"> </span><span class="n">lane_map_width_</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32FC1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">lane_map</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_detected_blob</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">(),</span><span class="w"></span>
<span class="w">         </span><span class="n">lane_map_width_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lane_map_height_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 从lane_map中采样点，并且投影他们到世界坐标</span>
<span class="w">  </span><span class="c1">// TODO(techoe): Should be fixed</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lane_map</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// TODO(techoe): Should be fixed</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">step_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">6400</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">xy_points</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">xy_points</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">lane_type_num_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">uv_points</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">uv_points</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">lane_type_num_</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 3.1 如果y大于0，每次移动step</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 3.2 每次移动一列</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// 3.3 获取最大行，最小列的点的值</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">lane_map</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// 3.4 如果lane在车道左边，value的值在spatialLUTind中      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// right edge (inner) of the lane</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">lane_map</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">img_point</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_width_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">cols</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_height_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">roi_start_</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="mf">1.0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xy_p</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">xy_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trans_mat_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">img_point</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xy_point</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uv_point</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">fabs</span><span class="p">(</span><span class="n">xy_p</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">xy_point</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Filter out lane line points</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_point</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w">  </span><span class="c1">// This condition is only for front camera</span>
<span class="w">              </span><span class="n">xy_point</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_longitudinal_distance_</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">xy_point</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">30.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">uv_point</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_width_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">cols</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_height_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">roi_start_</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="c1">// 3.4 将xy_point放入xy_points，将uv_point放入uv_points</span>
<span class="w">          </span><span class="c1">// xy_points存放的是Lane的世界坐标，uv_points存放的是图像坐标</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">xy_point</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">50.0f</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">fabs</span><span class="p">(</span><span class="n">xy_point</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xy_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">back</span><span class="p">()(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">xy_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">xy_point</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">uv_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">uv_point</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lane_type_num_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Left edge (inner) of the lane</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">lane_map</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">img_point</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_width_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">cols</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_height_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">roi_start_</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="mf">1.0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xy_p</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">xy_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trans_mat_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">img_point</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xy_point</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uv_point</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">fabs</span><span class="p">(</span><span class="n">xy_p</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">xy_point</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xy_p</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Filter out lane line points</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_point</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w">  </span><span class="c1">// This condition is only for front camera</span>
<span class="w">              </span><span class="n">xy_point</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_longitudinal_distance_</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">xy_point</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">30.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">uv_point</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_width_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">cols</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">roi_height_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lane_map</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">roi_start_</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">xy_point</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">50.0f</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">fabs</span><span class="p">(</span><span class="n">xy_point</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xy_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">back</span><span class="p">()(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">xy_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">xy_point</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">uv_points</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">uv_point</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lane_type_num_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">AWARN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Lane line value shouldn&#39;t be equal or more than: &quot;</span><span class="w"></span>
<span class="w">                </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">lane_type_num_</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">step_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">6400</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">step_y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">elapsed_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">microseconds_1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">elapsed_1</span><span class="p">).</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">time_1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">microseconds_1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 4.移除异常值并进行ransac拟合</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">coeffs</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">img_coeffs</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">selected_xy_points</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">coeffs</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">lane_type_num_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">img_coeffs</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">lane_type_num_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lane_type_num_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 4.1 xy_points[i]即是每种类型lane中抽样的点的数组</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">coeff</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Solve linear system to estimate polynomial coefficients</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RansacFitting</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">selected_xy_points</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">coeff</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">minNumPoints_</span><span class="p">),</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coeff</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selected_xy_points</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">elapsed_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">microseconds_2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">elapsed_2</span><span class="p">).</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">time_2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">microseconds_2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">microseconds_1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 3. Write values into lane_objects</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">c0s</span><span class="p">(</span><span class="n">lane_type_num_</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lane_type_num_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">c0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPolyValue</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">3</span><span class="p">)),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">3.0</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 在特殊情况下确定车道空间标签</span>
<span class="w">  </span><span class="c1">// 1.检查左边车道线是否小于最小采样点 2.检查右边车道线是否小于最小采样点</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">uv_points</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">uv_points</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">coeffs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">c0s</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">             </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">uv_points</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">uv_points</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">coeffs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">c0s</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Use left lane boundary as the right most missing left lane,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_boundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">use_boundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_boundary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">uv_points</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">uv_points</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">coeffs</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">c0s</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Use right lane boundary as the left most missing right lane,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_boundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">use_boundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_boundary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">xy_points</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">uv_points</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">uv_points</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">coeffs</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">c0s</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lane_type_num_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">base</span><span class="o">::</span><span class="n">LaneLine</span><span class="w"> </span><span class="n">cur_object</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNumPoints_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// [2] Set spatial label</span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">pos_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialLUT</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="c1">// [3] Determine which lines are valid according to the y value at x = 3</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">c0s</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">c0s</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">c0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">c0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c0s</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">11</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// [4] 结果写入cur_object</span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">x_start</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">front</span><span class="p">()(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">x_end</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">back</span><span class="p">()(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="c1">// if (cur_object.curve_car_coord.x_end -</span>
<span class="w">    </span><span class="c1">//     cur_object.curve_car_coord.x_start &lt; 5) continue;</span>
<span class="w">    </span><span class="c1">// cur_object.order = 2;</span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord_point_set</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">base</span><span class="o">::</span><span class="n">Point2DF</span><span class="w"> </span><span class="n">p_j</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">p_j</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">](</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">p_j</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">xy_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">](</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_car_coord_point_set</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">p_j</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_image_point_set</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">uv_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">base</span><span class="o">::</span><span class="n">Point2DF</span><span class="w"> </span><span class="n">p_j</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">p_j</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">uv_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">](</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">p_j</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">uv_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">](</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">cur_object</span><span class="p">.</span><span class="n">curve_image_point_set</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">p_j</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// cur_object.confidence.push_back(1);</span>
<span class="w">    </span><span class="n">cur_object</span><span class="p">.</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cur_object</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Special case riding on a lane:</span>
<span class="w">  </span><span class="c1">// 0: no center lane, 1: center lane as left, 2: center lane as right</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">has_center_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">lane_</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lane_</span><span class="p">.</span><span class="n">pos_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">LaneLinePositionType</span><span class="o">::</span><span class="n">EGO_CENTER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lane_</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">d</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">has_center_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lane_</span><span class="p">.</span><span class="n">curve_car_coord</span><span class="p">.</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">has_center_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Change labels for all lanes from one side</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_center_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lane_</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">spatial_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialLUTind</span><span class="p">[</span><span class="n">lane_</span><span class="p">.</span><span class="n">pos_type</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spatial_id</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">spatial_id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">lane_</span><span class="p">.</span><span class="n">pos_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialLUT</span><span class="p">[</span><span class="n">spatial_id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_center_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lane_</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">spatial_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialLUTind</span><span class="p">[</span><span class="n">lane_</span><span class="p">.</span><span class="n">pos_type</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spatial_id</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">spatial_id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">lane_</span><span class="p">.</span><span class="n">pos_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialLUT</span><span class="p">[</span><span class="n">spatial_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">microseconds</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">elapsed</span><span class="p">).</span><span class="n">count</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// AINFO &lt;&lt; &quot;Time for writing: &quot; &lt;&lt; microseconds - microseconds_2 &lt;&lt; &quot; us&quot;;</span>
<span class="w">  </span><span class="n">time_3</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">microseconds</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">microseconds_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">++</span><span class="n">time_num</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;frame-&gt;lane_objects.size(): &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Avg sampling time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">time_1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">time_num</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; Avg fitting time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">time_2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">time_num</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; Avg writing time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">time_3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">time_num</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;darkSCNN lane_postprocess done!&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="darkscnn">
<h2>DarkSCNN<a class="headerlink" href="#darkscnn" title="Permalink to this headline"></a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Produce laneline output in camera coordinates (optional)</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">DarkSCNNLanePostprocessor::Process3D</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">LanePostprocessorOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">CameraFrame</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ConvertImagePoint2Camera</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">PolyFitCameraLaneline</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>图片坐标转换到相机</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">DarkSCNNLanePostprocessor::ConvertImagePoint2Camera</span><span class="p">(</span><span class="n">CameraFrame</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">pitch_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">calibration_service</span><span class="o">-&gt;</span><span class="n">QueryPitchAngle</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">camera_ground_height</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">calibration_service</span><span class="o">-&gt;</span><span class="n">QueryCameraToGroundHeight</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="o">&amp;</span><span class="w"> </span><span class="n">intrinsic_params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">camera_k_matrix</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="o">&amp;</span><span class="w"> </span><span class="n">intrinsic_params_inverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intrinsic_params</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">LaneLine</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">lane_objects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">laneline_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lane_objects</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">line_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">line_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">laneline_num</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">line_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Point2DF</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">image_point_set</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_image_point_set</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Point3DF</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">camera_point_set</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_point_set</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image_point_set</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">base</span><span class="o">::</span><span class="n">Point3DF</span><span class="w"> </span><span class="n">camera_point</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">camera_point3d</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Point2DF</span><span class="o">&amp;</span><span class="w"> </span><span class="n">image_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_point_set</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">ImagePoint2Camera</span><span class="p">(</span><span class="n">image_point</span><span class="p">,</span><span class="w"> </span><span class="n">pitch_angle</span><span class="p">,</span><span class="w"> </span><span class="n">camera_ground_height</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">intrinsic_params_inverse</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_point3d</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">camera_point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">camera_point3d</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">camera_point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">camera_point3d</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">camera_point</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">camera_point3d</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">camera_point_set</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">camera_point</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>获取车道线点</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">DarkSCNNLanePostprocessor::PolyFitCameraLaneline</span><span class="p">(</span><span class="n">CameraFrame</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">LaneLine</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">lane_objects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">laneline_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lane_objects</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">line_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">line_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">laneline_num</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">line_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Point3DF</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">camera_point_set</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_point_set</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// z: longitudinal direction</span>
<span class="w">    </span><span class="c1">// x: latitudinal direction</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_point_set</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">z</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="n">max_poly_order</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">camera_coeff</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">camera_pos_vec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">camera_point_set</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">camera_point_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">x_end</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">x_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">camera_point_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">x_start</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">camera_pos</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">camera_pos</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">camera_point_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">camera_point_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">camera_pos_vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">camera_pos</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_x_axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">fit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">PolyFit</span><span class="p">(</span><span class="n">camera_pos_vec</span><span class="p">,</span><span class="w"> </span><span class="n">max_poly_order</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">camera_coeff</span><span class="p">,</span><span class="w"> </span><span class="n">is_x_axis</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fit_flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_coord</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_coeff</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_coord</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_coeff</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_coord</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_coeff</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_coord</span><span class="p">.</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera_coeff</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_coord</span><span class="p">.</span><span class="n">x_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_start</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">curve_camera_coord</span><span class="p">.</span><span class="n">x_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_end</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">lane_objects</span><span class="p">[</span><span class="n">line_index</span><span class="p">].</span><span class="n">use_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">LaneLineUseType</span><span class="o">::</span><span class="n">REAL</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>数据集<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h2>
<p><a class="reference external" href="https://xingangpan.github.io/projects/CULane.html">CULane Dataset</a><br />
<a class="reference external" href="https://bdd-data.berkeley.edu/">bdd</a><br />
<a class="reference external" href="https://github.com/TuSimple/tusimple-benchmark">tusimple</a></p>
</div>
<div class="section" id="id5">
<h2>参考<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h2>
<p><a class="reference external" href="https://github.com/amusi/awesome-lane-detection">awesome-lane-detection</a></p>
</div>
</div>
<div class="section" id="calibration-service-calibrator">
<h1>calibration_service &amp; calibrator<a class="headerlink" href="#calibration-service-calibrator" title="Permalink to this headline"></a></h1>
<p>首先看OnlineCalibrationService类的实现。</p>
<div class="section" id="onlinecalibrationservice">
<h2>OnlineCalibrationService<a class="headerlink" href="#onlinecalibrationservice" title="Permalink to this headline"></a></h2>
<p>初始化Init</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">OnlineCalibrationService::Init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CalibrationServiceInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">master_sensor_name_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">calibrator_working_sensor_name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">sensor_name_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">calibrator_working_sensor_name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 初始化K矩阵</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name_intrinsic_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">name_intrinsic_map</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">name_intrinsic_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">master_sensor_name_</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">         </span><span class="n">name_intrinsic_map</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">CameraStatus</span><span class="w"> </span><span class="n">camera_status</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">name_camera_status_map_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_intrinsic_map</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">name_intrinsic_map</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="o">++</span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">camera_status</span><span class="p">.</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">camera_status</span><span class="p">.</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">camera_status</span><span class="p">.</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">camera_status</span><span class="p">.</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">camera_status</span><span class="p">.</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">name_camera_status_map_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">CameraStatus</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">camera_status</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 初始化校准参数</span>
<span class="w">  </span><span class="n">CalibratorInitOptions</span><span class="w"> </span><span class="n">calibrator_init_options</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">calibrator_init_options</span><span class="p">.</span><span class="n">image_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">image_width</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">calibrator_init_options</span><span class="p">.</span><span class="n">image_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">image_height</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">calibrator_init_options</span><span class="p">.</span><span class="n">focal_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">name_camera_status_map_</span><span class="p">[</span><span class="n">master_sensor_name_</span><span class="p">].</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">calibrator_init_options</span><span class="p">.</span><span class="n">focal_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">name_camera_status_map_</span><span class="p">[</span><span class="n">master_sensor_name_</span><span class="p">].</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">calibrator_init_options</span><span class="p">.</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">name_camera_status_map_</span><span class="p">[</span><span class="n">master_sensor_name_</span><span class="p">].</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">calibrator_init_options</span><span class="p">.</span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">name_camera_status_map_</span><span class="p">[</span><span class="n">master_sensor_name_</span><span class="p">].</span><span class="n">k_matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">calibrator_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">BaseCalibratorRegisterer</span><span class="o">::</span><span class="n">GetInstanceByName</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">calibrator_method</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">calibrator_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">calibrator_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">calibrator_init_options</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to init &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">calibrator_method</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>更新帧信息</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">OnlineCalibrationService::Update</span><span class="p">(</span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">sensor_name_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">sensor_name</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sensor_name_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">master_sensor_name_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CalibratorOptions</span><span class="w"> </span><span class="n">calibrator_options</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">calibrator_options</span><span class="p">.</span><span class="n">lane_objects</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">LaneLine</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">lane_objects</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">calibrator_options</span><span class="p">.</span><span class="n">camera2world_pose</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3d</span><span class="o">&gt;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">camera2world_pose</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">calibrator_options</span><span class="p">.</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">pitch_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 1. 校准传感器参数</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calibrator_</span><span class="o">-&gt;</span><span class="n">Calibrate</span><span class="p">(</span><span class="n">calibrator_options</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pitch_angle</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// rebuild the service when updated</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">name_camera_status_map_</span><span class="p">[</span><span class="n">master_sensor_name_</span><span class="p">].</span><span class="n">pitch_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pitch_angle</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_camera_status_map_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">           </span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">name_camera_status_map_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">iter</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 2. 更新俯仰角</span>
<span class="w">        </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">pitch_angle</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">pitch_angle_diff</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">            </span><span class="n">name_camera_status_map_</span><span class="p">[</span><span class="n">master_sensor_name_</span><span class="p">].</span><span class="n">pitch_angle</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 3. 更新地平面</span>
<span class="w">        </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">ground_plane</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">pitch_angle</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">ground_plane</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">pitch_angle</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_camera_status_map_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">sensor_name_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;camera_ground_height: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">camera_ground_height</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; meter.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;pitch_angle: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">pitch_angle</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">180.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">M_PI</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; degree.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">is_service_ready_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="calibrator">
<h2>calibrator<a class="headerlink" href="#calibrator" title="Permalink to this headline"></a></h2>
<p>LaneLineCalibrator依赖LaneBasedCalibrator。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">LaneLineCalibrator::Calibrate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CalibratorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">pitch_angle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 加载当前车道线</span>
<span class="w">  </span><span class="n">EgoLane</span><span class="w"> </span><span class="n">ego_lane</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LoadEgoLaneline</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">.</span><span class="n">lane_objects</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ego_lane</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to get the ego lane.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">cam_ori</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">cam_ori</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 相机坐标到世界坐标</span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3d</span><span class="w"> </span><span class="n">c2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">.</span><span class="n">camera2world_pose</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">c2w</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">c2w</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">c2w</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>

<span class="w">  </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;c2w transform this frame:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">p2w</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="n">common</span><span class="o">::</span><span class="n">IMultAx3x4</span><span class="p">(</span><span class="n">p2w</span><span class="p">,</span><span class="w"> </span><span class="n">cam_ori</span><span class="p">,</span><span class="w"> </span><span class="n">cam_coord_cur_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">time_diff_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kTimeDiffDefault</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">yaw_rate_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kYawRateDefault</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">velocity_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kVelocityDefault</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">timestamp_cur_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_first_frame_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">time_diff_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabsf</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">timestamp_cur_</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp_pre_</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">timestamp_cur_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">timestamp_pre_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">camera</span><span class="o">::</span><span class="n">GetYawVelocityInfo</span><span class="p">(</span><span class="n">time_diff_</span><span class="p">,</span><span class="w"> </span><span class="n">cam_coord_cur_</span><span class="p">,</span><span class="w"> </span><span class="n">cam_coord_pre_</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">cam_coord_pre_pre_</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">yaw_rate_</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">velocity_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">timediff_yawrate_velocity_text</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">absl</span><span class="o">::</span><span class="n">StrCat</span><span class="p">(</span><span class="s">&quot;time_diff_: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">time_diff_</span><span class="p">).</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="s">&quot; | yaw_rate_: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">yaw_rate_</span><span class="p">).</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="s">&quot; | velocity_: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">velocity_</span><span class="p">).</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">timediff_yawrate_velocity_text</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">calibrator_</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">ego_lane</span><span class="p">,</span><span class="w"> </span><span class="n">velocity_</span><span class="p">,</span><span class="w"> </span><span class="n">yaw_rate_</span><span class="p">,</span><span class="w"> </span><span class="n">time_diff_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">pitch_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calibrator_</span><span class="p">.</span><span class="n">get_pitch_estimation</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">vanishing_row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calibrator_</span><span class="p">.</span><span class="n">get_vanishing_row</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;#updated pitch angle: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pitch_angle</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;#vanishing row: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vanishing_row</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_first_frame_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">cam_coord_pre_pre_</span><span class="p">,</span><span class="w"> </span><span class="n">cam_coord_pre_</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">is_first_frame_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">cam_coord_pre_</span><span class="p">,</span><span class="w"> </span><span class="n">cam_coord_cur_</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">timestamp_pre_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestamp_cur_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">updated</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>LaneBasedCalibrator的校准过程。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">LaneBasedCalibrator::Process</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">EgoLane</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lane</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">velocity</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">yaw_rate</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time_diff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">distance_traveled_in_meter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_diff</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">vehicle_yaw_changed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yaw_rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_diff</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 1. 检查是否直行</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsTravelingStraight</span><span class="p">(</span><span class="n">vehicle_yaw_changed</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Do not calibate if not moving straight: &quot;</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;yaw angle changed &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vehicle_yaw_changed</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">vp_buffer_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">VanishingPoint</span><span class="w"> </span><span class="n">vp_cur</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">VanishingPoint</span><span class="w"> </span><span class="n">vp_work</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 从车道获取当前消失点的估计值</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">GetVanishingPoint</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vp_cur</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Lane is not valid for calibration.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">vp_cur</span><span class="p">.</span><span class="n">distance_traveled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distance_traveled_in_meter</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Push vanishing point into buffer</span>
<span class="w">  </span><span class="n">PushVanishingPoint</span><span class="p">(</span><span class="n">vp_cur</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PopVanishingPoint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp_work</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Driving distance is not long enough&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 获取当前的音高估计</span>
<span class="w">  </span><span class="n">pitch_cur_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">GetPitchFromVanishingPoint</span><span class="p">(</span><span class="n">vp_work</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pitch_cur_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to estimate pitch from vanishing point.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">vanishing_row_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vp_work</span><span class="p">.</span><span class="n">pixel_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Get the filtered output using histogram</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">AddPitchToHistogram</span><span class="p">(</span><span class="n">pitch_cur_</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Calculated pitch is out-of-range.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">accumulated_straight_driving_in_meter_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">distance_traveled_in_meter</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">accumulated_straight_driving_in_meter_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">          </span><span class="n">params_</span><span class="p">.</span><span class="n">min_distance_to_update_calibration_in_meter</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">pitch_histogram_</span><span class="p">.</span><span class="n">Process</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pitch_estimation_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pitch_histogram_</span><span class="p">.</span><span class="n">get_val_estimation</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_mat_</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_mat_</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">vanishing_row_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tanf</span><span class="p">(</span><span class="n">pitch_estimation_</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cy</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">accumulated_straight_driving_in_meter_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="feature-extractor">
<h1>feature_extractor<a class="headerlink" href="#feature-extractor" title="Permalink to this headline"></a></h1>
<p>TrackingFeatureExtractor追踪特征提取器。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TrackingFeatureExtractor::Init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FeatureExtractorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">init_options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">//  setup bottom and top</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_options</span><span class="p">.</span><span class="n">feat_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_options</span><span class="p">.</span><span class="n">feat_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">input_height_</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">init_options</span><span class="p">.</span><span class="n">input_height</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">feat_height</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">init_options</span><span class="p">.</span><span class="n">input_height</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">input_width_</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">init_options</span><span class="p">.</span><span class="n">input_width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">feat_width</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">init_options</span><span class="p">.</span><span class="n">input_width</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">tracking_feature</span><span class="o">::</span><span class="n">FeatureParam</span><span class="w"> </span><span class="n">feat_param</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">config_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">init_options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">init_options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 1. 获取配置  </span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">feat_param</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">feat_param</span><span class="p">.</span><span class="n">extractor_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">input_height_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">feat_height</span><span class="p">,</span><span class="w"> </span><span class="n">input_width_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">feat_width</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Invalid aspect ratio: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">feat_height</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">feat_width</span><span class="w"></span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; from &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">input_height_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">input_width_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 2. 获取ROI区域pooling</span>
<span class="w">  </span><span class="n">feat_blob_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_options</span><span class="p">.</span><span class="n">feat_blob</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">feat_param</span><span class="p">.</span><span class="n">extractor_size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">feat_param</span><span class="p">.</span><span class="n">extractor</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">feat_type</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">tracking_feature</span><span class="o">::</span><span class="n">ExtractorParam_FeatureType_ROIPooling</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">init_roipooling</span><span class="p">(</span><span class="n">init_options</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">feat_param</span><span class="p">.</span><span class="n">extractor</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">roi_pooling_param</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">roi_poolings_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;no proper extractor&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>初始化感兴趣区域？</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">TrackingFeatureExtractor::init_roipooling</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FeatureExtractorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">tracking_feature</span><span class="o">::</span><span class="n">ROIPoolingParam</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">feat_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_height_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">feat_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_width_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">feat_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FeatureExtractorLayer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">feature_extractor_layer_ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feature_extractor_layer_ptr</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeatureExtractorLayer</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shape</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">rois_blob</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Blob</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">shape</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pooled_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">.</span><span class="n">pooled_w</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pooled_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">.</span><span class="n">pooled_h</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_floor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">.</span><span class="n">use_floor</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">pooling_layer</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">inference</span><span class="o">::</span><span class="n">ROIPoolingLayer</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pooled_h</span><span class="p">,</span><span class="w"> </span><span class="n">pooled_w</span><span class="p">,</span><span class="w"> </span><span class="n">use_floor</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="n">feat_channel</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">top_blob</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Blob</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">feat_blob_</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">(),</span><span class="w"> </span><span class="n">pooled_h</span><span class="p">,</span><span class="w"> </span><span class="n">pooled_w</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">roi_poolings_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">feature_extractor_layer_ptr</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>解压tracking特征</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">TrackingFeatureExtractor::Extract</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FeatureExtractorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">.</span><span class="n">normalized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">encode_bbox</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">feature_extractor_layer_ptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">roi_poolings_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">rois_blob</span><span class="o">-&gt;</span><span class="n">Reshape</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span><span class="w"> </span><span class="mi">5</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">rois_data</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">rois_blob</span><span class="o">-&gt;</span><span class="n">mutable_cpu_data</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">obj</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">xmin</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">feat_width_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">ymin</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">feat_height_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">xmax</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">feat_width_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">camera_supplement</span><span class="p">.</span><span class="n">box</span><span class="p">.</span><span class="n">ymax</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">feat_height_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"></span>
<span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rois_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">rois_data</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">rois_blob</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">pooling_layer</span><span class="o">-&gt;</span><span class="n">ForwardGPU</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="n">feat_blob_</span><span class="p">,</span><span class="w"> </span><span class="n">feature_extractor_layer_ptr</span><span class="o">-&gt;</span><span class="n">rois_blob</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">.</span><span class="n">normalized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">decode_bbox</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">norm_</span><span class="p">.</span><span class="n">L2Norm</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>ProjectFeature投影特征</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ProjectFeature::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FeatureExtractorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">efx_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">efx_config</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param_</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Read config failed: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">efx_config</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Load config Success: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">ShortDebugString</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">proto_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">proto_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">weight_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">weight_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input_names</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output_names</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">input_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">param_</span><span class="p">.</span><span class="n">input_blob</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">output_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">param_</span><span class="p">.</span><span class="n">feat_blob</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">model_type</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;model_type=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">model_type</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">inference</span><span class="o">::</span><span class="n">CreateInferenceByName</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">model_type</span><span class="p">,</span><span class="w"> </span><span class="n">proto_file</span><span class="p">,</span><span class="w"> </span><span class="n">weight_file</span><span class="p">,</span><span class="w"> </span><span class="n">output_names</span><span class="p">,</span><span class="w"> </span><span class="n">input_names</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="k">nullptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">inference_</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to init CNNAdapter&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">gpu_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GlobalConfig</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">track_feature_gpu_id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">set_gpu_id</span><span class="p">(</span><span class="n">gpu_id_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">set_max_batch_size</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shape_map</span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="n">param_</span><span class="p">.</span><span class="n">input_blob</span><span class="p">(),</span><span class="w"> </span><span class="n">shape</span><span class="p">}};</span><span class="w"></span>

<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">shape_map</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">Infer</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>解压特征</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ProjectFeature::Extract</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FeatureExtractorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">input_blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">get_blob</span><span class="p">(</span><span class="n">param_</span><span class="p">.</span><span class="n">input_blob</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">output_blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">get_blob</span><span class="p">(</span><span class="n">param_</span><span class="p">.</span><span class="n">feat_blob</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">input_blob</span><span class="o">-&gt;</span><span class="n">Reshape</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">input_blob</span><span class="o">-&gt;</span><span class="n">mutable_gpu_data</span><span class="p">(),</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="o">-&gt;</span><span class="n">gpu_data</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyDefault</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">Infer</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="o">-&gt;</span><span class="n">Reshape</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">detected_objects</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span><span class="w"> </span><span class="n">output_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">       </span><span class="n">output_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">output_blob</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">)});</span><span class="w"></span>

<span class="w">  </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="o">-&gt;</span><span class="n">mutable_gpu_data</span><span class="p">(),</span><span class="w"> </span><span class="n">output_blob</span><span class="o">-&gt;</span><span class="n">gpu_data</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyDefault</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">norm_</span><span class="p">.</span><span class="n">L2Norm</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">track_feature_blob</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>ExternalFeatureExtractor扩展特征初始化</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ExternalFeatureExtractor::Init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FeatureExtractorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">efx_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">conf_file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">cyber</span><span class="o">::</span><span class="n">common</span><span class="o">::</span><span class="n">GetProtoFromFile</span><span class="p">(</span><span class="n">efx_config</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param_</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Read config failed: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">efx_config</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Load config Success: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">ShortDebugString</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">proto_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">proto_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">weight_file</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">GetAbsolutePath</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">weight_file</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input_names</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output_names</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">input_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">param_</span><span class="p">.</span><span class="n">input_blob</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">output_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">param_</span><span class="p">.</span><span class="n">feat_blob</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">height_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">resize_height</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">width_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">resize_width</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_</span><span class="p">.</span><span class="n">model_type</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;model_type=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">model_type</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">inference</span><span class="o">::</span><span class="n">CreateInferenceByName</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">model_type</span><span class="p">,</span><span class="w"> </span><span class="n">proto_file</span><span class="p">,</span><span class="w"> </span><span class="n">weight_file</span><span class="p">,</span><span class="w"> </span><span class="n">output_names</span><span class="p">,</span><span class="w"> </span><span class="n">input_names</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="k">nullptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">inference_</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to init CNNAdapter&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">gpu_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GlobalConfig</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">track_feature_gpu_id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">set_gpu_id</span><span class="p">(</span><span class="n">gpu_id_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">height_</span><span class="p">,</span><span class="w"> </span><span class="n">width_</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shape_map</span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="n">param_</span><span class="p">.</span><span class="n">input_blob</span><span class="p">(),</span><span class="w"> </span><span class="n">shape</span><span class="p">}};</span><span class="w"></span>

<span class="w">  </span><span class="n">ACHECK</span><span class="p">(</span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">shape_map</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">Infer</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">InitFeatureExtractor</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">root_dir</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">image_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Image8U</span><span class="p">(</span><span class="n">height_</span><span class="p">,</span><span class="w"> </span><span class="n">width_</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Color</span><span class="o">::</span><span class="n">BGR</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>扩展特征解压</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">ExternalFeatureExtractor::Extract</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FeatureExtractorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">raw_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_height</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">raw_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">input_blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">get_blob</span><span class="p">(</span><span class="n">param_</span><span class="p">.</span><span class="n">input_blob</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">DataProvider</span><span class="o">::</span><span class="n">ImageOptions</span><span class="w"> </span><span class="n">image_options</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">image_options</span><span class="p">.</span><span class="n">target_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">Color</span><span class="o">::</span><span class="n">BGR</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">offset_y_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">param_</span><span class="p">.</span><span class="n">offset_ratio</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw_height</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">image_options</span><span class="p">.</span><span class="n">crop_roi</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">base</span><span class="o">::</span><span class="n">RectI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">offset_y_</span><span class="p">,</span><span class="w"> </span><span class="n">raw_width</span><span class="p">,</span><span class="w"> </span><span class="n">raw_height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset_y_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">image_options</span><span class="p">.</span><span class="n">do_crop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Timer timer;</span>
<span class="w">  </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data_provider</span><span class="o">-&gt;</span><span class="n">GetImage</span><span class="p">(</span><span class="n">image_options</span><span class="p">,</span><span class="w"> </span><span class="n">image_</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">inference</span><span class="o">::</span><span class="n">ResizeGPU</span><span class="p">(</span><span class="o">*</span><span class="n">image_</span><span class="p">,</span><span class="w"> </span><span class="n">input_blob</span><span class="p">,</span><span class="w"> </span><span class="n">raw_width</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">inference_</span><span class="o">-&gt;</span><span class="n">Infer</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">FeatureExtractorOptions</span><span class="w"> </span><span class="n">feat_options</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feat_options</span><span class="p">.</span><span class="n">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">feature_extractor_</span><span class="o">-&gt;</span><span class="n">set_roi</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">image_options</span><span class="p">.</span><span class="n">crop_roi</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">image_options</span><span class="p">.</span><span class="n">crop_roi</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">image_options</span><span class="p">.</span><span class="n">crop_roi</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">image_options</span><span class="p">.</span><span class="n">crop_roi</span><span class="p">.</span><span class="n">height</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">feature_extractor_</span><span class="o">-&gt;</span><span class="n">Extract</span><span class="p">(</span><span class="n">feat_options</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">AINFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Extract Done&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, daohu527.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>