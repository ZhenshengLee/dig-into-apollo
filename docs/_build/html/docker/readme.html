
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dig into Apollo - Docker &#8212; dig-into-apollo  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Dig into Apollo - Cyber" href="../cyber/readme.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="dig-into-apollo-docker-github">
<h1>Dig into Apollo - Docker <img alt="GitHub" src="https://img.shields.io/github/license/daohu527/Dig-into-Apollo.svg?style=popout" /><a class="headerlink" href="#dig-into-apollo-docker-github" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>橘生淮南则为橘，生于淮北则为枳。</p>
</div></blockquote>
<div class="section" id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><span class="xref myst">docker编译</span></p></li>
<li><p><span class="xref myst">docker脚本</span></p></li>
<li><p><span class="xref myst">设置主机</span></p></li>
</ul>
<p>docker的主要的好处是开箱即用，在编译docker的时候安装好需要的环境，在使用的时候就无需担心环境问题带来的影响了。下面我们主要分析下docker文件夹中的脚本，主要涉及docker的编译、启动、以及host相关的内容。</p>
<a name="docker_build" />
</div>
<div class="section" id="docker">
<h2>docker编译<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h2>
<p>编译docker在目录中”apollo\docker\build”中，执行的命令为</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">build_dev</span><span class="o">.</span><span class="n">sh</span> <span class="o">./</span><span class="n">dev</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">dockerfile</span>
</pre></div>
</div>
<p>在”build_dev.sh”脚本中会执行编译docker的工作，下面我们分析下docker的编译过程。</p>
<div class="section" id="build-dev-sh">
<h3>build_dev.sh<a class="headerlink" href="#build-dev-sh" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Usage:
#   ./build_dev.sh ./dev.x86_64.dockerfile
# 1. 获取dockerfile名称，这里为第一个参数
DOCKERFILE=$1

# 2. 获取build_dev.sh的目录路径
CONTEXT=&quot;$(dirname &quot;${BASH_SOURCE[0]}&quot;)&quot;

REPO=apolloauto/apollo
ARCH=$(uname -m)
TIME=$(date +%Y%m%d_%H%M)

TAG=&quot;${REPO}:dev-18.04-${ARCH}-${TIME}&quot;

# Fail on first error.
set -e
# 3. 编译docker
docker build -t ${TAG} -f ${DOCKERFILE} ${CONTEXT}
echo &quot;Built new image ${TAG}&quot;
</pre></div>
</div>
<p>其中解释下几个参数：
-t : 设置docker的tag名称
-f : 默认不需要设置这个参数，docker会从当前目录中找dockerfile编译，当有多个dockerfile的时候就需要通过”-f”来指定编译的dockerfile
CONTEXT ： docker编译的资源目录</p>
<p><a class="reference external" href="https://docs.docker.com/engine/reference/commandline/build/">参考</a></p>
<p><strong>疑问</strong></p>
<ol class="arabic simple">
<li><p>ARM架构和X86_64架构的docker编译有什么区别？</p></li>
</ol>
<p>接着我们来看dockerfile</p>
</div>
<div class="section" id="dev-x86-64-dockerfile">
<h3>dev.x86_64.dockerfile<a class="headerlink" href="#dev-x86-64-dockerfile" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. 以nvidia/cuda:10.0做为基础镜像</span>
<span class="n">FROM</span> <span class="n">nvidia</span><span class="o">/</span><span class="n">cuda</span><span class="p">:</span><span class="mf">10.0</span><span class="o">-</span><span class="n">cudnn7</span><span class="o">-</span><span class="n">devel</span><span class="o">-</span><span class="n">ubuntu18</span><span class="mf">.04</span>

<span class="n">ENV</span> <span class="n">DEBIAN_FRONTEND</span><span class="o">=</span><span class="n">noninteractive</span>

<span class="c1"># 2. 安装软件</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">-</span><span class="n">y</span> <span class="o">&amp;&amp;</span> \
    <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> \
    <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span> \
    <span class="n">autotools</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">automake</span> \
    <span class="n">bc</span> \
    <span class="n">build</span><span class="o">-</span><span class="n">essential</span> \
    <span class="n">cmake</span> \
    <span class="n">cppcheck</span> \
    <span class="n">curl</span> \
    <span class="n">curlftpfs</span> \
    <span class="n">debconf</span><span class="o">-</span><span class="n">utils</span> \
    <span class="n">doxygen</span> \
    <span class="n">gdb</span> \
    <span class="n">git</span> \
    <span class="n">google</span><span class="o">-</span><span class="n">perftools</span> \
    <span class="n">graphviz</span> \
    <span class="n">iproute2</span> \
    <span class="n">iputils</span><span class="o">-</span><span class="n">ping</span> \
    <span class="n">lcov</span> \
    <span class="n">libblas</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">libssl</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">libboost</span><span class="o">-</span><span class="nb">all</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">libcurl4</span><span class="o">-</span><span class="n">openssl</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">libfreetype6</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">liblapack</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">libpcap</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">libsqlite3</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">libgtest</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">locate</span> \
    <span class="n">lsof</span> \
    <span class="n">nfs</span><span class="o">-</span><span class="n">common</span> \
    <span class="n">python</span><span class="o">-</span><span class="n">autopep8</span> \
    <span class="n">shellcheck</span> \
    <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span> \
    <span class="n">sshfs</span> \
    <span class="n">subversion</span> \
    <span class="n">unzip</span> \
    <span class="n">uuid</span><span class="o">-</span><span class="n">dev</span> \
    <span class="n">v4l</span><span class="o">-</span><span class="n">utils</span> \
    <span class="n">vim</span> \
    <span class="n">wget</span> \
    <span class="n">libasound2</span><span class="o">-</span><span class="n">dev</span> \
    <span class="nb">zip</span> <span class="o">&amp;&amp;</span> \
    <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">clean</span> <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span><span class="o">/*</span> <span class="o">&amp;&amp;</span> \
    <span class="n">echo</span> <span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">rsa</span>

<span class="c1"># Run installers.</span>
<span class="c1"># 3. 拷贝installers中的脚本，并且执行</span>
<span class="n">COPY</span> <span class="n">installers</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span>
<span class="c1"># 4. 安装adv，作用？？？</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_adv_plat</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 5. 安装bazel</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_bazel</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 6. 安装bazel依赖的包</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_bazel_packages</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 7. 网络文件系统，百度bosfs基于libfuse</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_bosfs</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 8. 安装conda，包管理软件</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_conda</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 9. 安装ffmpeg，用于视频处理</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_ffmpeg</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 10. 安装gflag</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_gflags_glog</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 11. openGL扩展</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_glew</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 12. google代码规范</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_google_styleguide</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 13. 安装caffe</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_gpu_caffe</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 14. 连续系统的大规模非线性优化的软件库</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_ipopt</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 15. osqp求解器</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_osqp</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 16. json rpc调用，是哪个开源库没有备注</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_libjsonrpc</span><span class="o">-</span><span class="n">cpp</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 17. nonlinear optimization非线性优化</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_nlopt</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 18. node.js版本管理</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_node</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 19. 视频编解码库</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_openh264</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 20. ota安全包，具体是？？？</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_ota</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 21. 安装pcl点云库</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_pcl</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 22. poco提供快速的可移植的网络开发</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_poco</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 23. 安装protobuf</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_protobuf</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 24. 安装python模块</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_python_modules</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 25. qp库</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_qp_oases</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 26. 安装QT</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_qt</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 27.</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_supervisor</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 28. 2D图像的变换</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_undistort</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 29. 增加用户，并且添加初始化脚本</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_user</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 30. 安装yarn，nodejs管理工具？？？</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_yarn</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 31. 性能调试库</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">post_install</span><span class="o">.</span><span class="n">sh</span>
<span class="c1"># 32. 音频编解码</span>
<span class="n">RUN</span> <span class="n">bash</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">installers</span><span class="o">/</span><span class="n">install_opuslib</span><span class="o">.</span><span class="n">sh</span>

<span class="c1"># 33. 设置工作路径和用户为apollo</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">apollo</span>
<span class="n">USER</span> <span class="n">apollo</span>

</pre></div>
</div>
<p>还有一些没有用到的脚本</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.  
install_adolc.sh

2. 安装fast-rtps，一个网络发现协议
install_fast-rtps.sh

3. 安装pytorch
install_libtorch.sh
</pre></div>
</div>
<a name="docker_script" />
</div>
</div>
<div class="section" id="id1">
<h2>docker脚本<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>容器相关的脚本在”scripts”中，下面我逐步分析下这些脚本做了哪些工作。</p>
<div class="section" id="dev-start-sh">
<h3>dev_start.sh<a class="headerlink" href="#dev-start-sh" title="Permalink to this headline">¶</a></h3>
<p>启动容器的脚本</p>
</div>
<div class="section" id="dev-into-sh">
<h3>dev_into.sh<a class="headerlink" href="#dev-into-sh" title="Permalink to this headline">¶</a></h3>
<p>进入容器的脚本</p>
<a name="setup_host" />
</div>
</div>
<div class="section" id="id2">
<h2>设置主机<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>设置host，提供了一些在主机上使用的脚本</p>
<div class="section" id="cleanup-resources-sh">
<h3>cleanup_resources.sh<a class="headerlink" href="#cleanup-resources-sh" title="Permalink to this headline">¶</a></h3>
<p>清楚宿主机上的docker镜像，卷</p>
</div>
<div class="section" id="install-docker-sh-install-nvidia-docker-sh">
<h3>install_docker.sh &amp; install_nvidia_docker.sh<a class="headerlink" href="#install-docker-sh-install-nvidia-docker-sh" title="Permalink to this headline">¶</a></h3>
<p>安装docker</p>
</div>
<div class="section" id="setup-host-sh">
<h3>setup_host.sh<a class="headerlink" href="#setup-host-sh" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>APOLLO_ROOT_DIR=&quot;$( cd &quot;$( dirname &quot;${BASH_SOURCE[0]}&quot; )/../..&quot; &amp;&amp; pwd )&quot;

# Setup core dump format.
if [ -e /proc/sys/kernel ]; then
  echo &quot;${APOLLO_ROOT_DIR}/data/core/core_%e.%p&quot; | \
      sudo tee /proc/sys/kernel/core_pattern
fi

# 设置每1分钟进行NTP时间同步
# Setup ntpdate to run once per minute. Log at /var/log/syslog.
grep -q ntpdate /etc/crontab
if [ $? -ne 0 ]; then
  echo &quot;*/1 * * * * root ntpdate -v -u us.pool.ntp.org&quot; | \
      sudo tee -a /etc/crontab
fi

# 使用udev管理设备文件
# Add udev rules.
sudo cp -r ${APOLLO_ROOT_DIR}/docker/setup_host/etc/* /etc/

# 
# Add uvcvideo clock config.
grep -q uvcvideo /etc/modules
if [ $? -ne 0 ]; then
  echo &quot;uvcvideo clock=realtime&quot; | sudo tee -a /etc/modules
fi
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">dig-into-apollo</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../cyber/readme.html">Dig into Apollo - Cyber </a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Dig into Apollo - Docker </a><ul>
<li class="toctree-l2"><a class="reference internal" href="#table-of-contents">Table of Contents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#docker">docker编译</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">docker脚本</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">设置主机</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../cyber/readme.html" title="previous chapter">Dig into Apollo - Cyber </a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, daohu527.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/docker/readme.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>